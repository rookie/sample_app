/*    HTTP Host:  b.static.ak.fbcdn.net                                        */
/*    Generated:  February 17th 2010 2:10:48 PM PST                            */
/*      Machine:  10.16.140.108                                                */
/*       Source:  Local Cache                                                  */
/*     Location:  rsrc:4:2wm4ys2w                                              */
/*       Locale:  nu_ll                                                        */
/*         Path:  js/7zag5lrpmq8s8wgg.pkg.js                                   */

((location=='about:blank'&&(window.parent.eval_global||window.parent.eval))||(window.eval_global||window.eval))("if (window.CavalryLogger) { CavalryLogger.start_js([\"js\\\/7zag5lrpmq8s8wgg.pkg.js\"]); }\n\nArbiter.inform(\"template\\\/registerTemplate\", {\"name\":\"\\\/gigaboxx\\\/templates\\\/ThreadMessageRow.tmpl\",\"template\":\"\\n<div bindPoint=\\\"root\\\" class=\\\"GBThreadMessageRow clearfix\\\">\\n  <div class=\\\"GBThreadMessageRow_Image\\\">\\n    <a class=\\\"GBThreadMessageRow_Image_Link\\\" href=\\\"${author_href}\\\">\\n      <img class=\\\"UIProfileImage UIProfileImage_Large\\\" src=\\\"${author_image_src}\\\" \\\/>\\n    <\\\/a>\\n  <\\\/div>\\n\\n  <div class=\\\"GBThreadMessageRow_Main\\\">\\n    <div class=\\\"GBThreadMessageRow_Info\\\">\\n      <span bindPoint=\\\"authorLinkWrapper\\\" class=\\\"GBThreadMessageRow_AuthorLink_Wrapper\\\">\\n        ${author_pre}<a class=\\\"GBThreadMessageRow_AuthorLink\\\" href=\\\"${author_href}\\\">${author_name}<\\\/a>${author_post}\\n      <\\\/span>\\n      <span class=\\\"GBThreadMessageRow_Date\\\">\\n        ${message_date}\\n      <\\\/span>\\n      <span class=\\\"GBThreadMessageRow_BranchLink\\\" bindPoint=\\\"branchLinkWrapper\\\"><\\\/span>\\n      <span class=\\\"GBThreadMessageRow_ReportLink\\\" bindPoint=\\\"reportLinkWrapper\\\"><\\\/span>\\n    <\\\/div>\\n    <div class=\\\"GBThreadMessageRow_Body\\\">\\n      <div class=\\\"GBThreadMessageRow_Body_Content\\\">\\n        $H{message_body}\\n      <\\\/div>\\n      <div class=\\\"GBThreadMessageRow_ReferrerLink\\\">\\n        $H{message_referrer}\\n      <\\\/div>\\n      <div class=\\\"GBThreadMessageRow_Body_Attachment\\\">\\n        $H{message_attachment}\\n      <\\\/div>\\n    <\\\/div>\\n  <\\\/div>\\n<\\\/div>\\n\"}, Arbiter.BEHAVIOR_PERSISTENT);\nArbiter.inform(\"template\\\/registerTemplate\", {\"name\":\"\\\/gigaboxx\\\/templates\\\/ThreadRow.tmpl\",\"template\":\"\\n<div bindPoint=\\\"root\\\" class=\\\"GBThreadRow\\\">\\n  <table bindPoint=\\\"thread_row\\\" id=\\\"${id}\\\" cellpadding=\\\"0\\\">\\n    <tr>\\n      <td class=\\\"badge_column\\\">\\n        <a href=\\\"\\\"\\n           class=\\\"badge\\\"\\n           bindPoint=\\\"badge\\\"\\n           listen=\\\"click: toggleUnread\\\"\\n           onselectstart=\\\"return false;\\\"><\\\/a>\\n      <\\\/td>\\n      <td class=\\\"checkbox\\\" onselectstart=\\\"return false;\\\">\\n        <label bindPoint=\\\"selectorLabel\\\">\\n          <input bindPoint=\\\"selector\\\"\\n                 listen=\\\"click: toggleSelect\\\"\\n                 type=\\\"checkbox\\\"\\n                 value=\\\"${id}\\\" \\\/>\\n        <\\\/label>\\n      <\\\/td>\\n      <td class=\\\"icon\\\">\\n        <div class=\\\"Thread_Icon\\\">\\n          <a bindPoint=\\\"iconAnchor\\\">\\n            <img class=\\\"UIProfileImage UIProfileImage_LARGE\\\" bindPoint=\\\"icon\\\" \\\/>\\n          <\\\/a>\\n        <\\\/div>\\n      <\\\/td>\\n      <td class=\\\"envelope clickable\\\" listen=\\\"click: readThread\\\">\\n        <div bindPoint=\\\"authors\\\" class=\\\"authors line\\\"><\\\/div>\\n        <div bindPoint=\\\"date\\\" class=\\\"date tagline\\\"><\\\/div>\\n      <\\\/td>\\n      <td class=\\\"thread_detail clickable\\\" listen=\\\"click: readThread\\\">\\n        <div bindPoint=\\\"subject\\\" class=\\\"subject line\\\"><\\\/div>\\n        <div bindPoint=\\\"preview\\\" class=\\\"preview tagline\\\"><\\\/div>\\n      <\\\/td>\\n      <td class=\\\"clickable\\\" listen=\\\"click: readThread\\\">\\n        <a href=\\\"\\\"\\n           class=\\\"delete_button UIObjectListing_RemoveLink\\\"\\n           bindPoint=\\\"deleteButton\\\"\\n           listen=\\\"click: deleteMessage\\\"><\\\/a>\\n      <\\\/td>\\n    <\\\/tr>\\n  <\\\/table>\\n<\\\/div>\\n\"}, Arbiter.BEHAVIOR_PERSISTENT);\nfunction inbox_search_typeahead(a,c,b){this.anchor_block=true;this.parent.construct(this,a,c,b);}inbox_search_typeahead.extend('typeaheadpro');copy_properties(inbox_search_typeahead.prototype,{auto_select:false,less_than_n_chars:true,touch_fired:false,show:function(){if(!this.less_than_n_chars&&this.suggestions.length){this.parent.show();this.dropdown.style.width='200px';}else this.hide();},hide:function(){this.parent.hide();var a=ge('inbox_search');if(a)CSS.removeClass(a,'typeahead_border');},fireTouch:function(){if(!this.touch_fired){AsyncRequest.pingURI('\/ajax\/gigaboxx\/endpoint\/SearchTouch.php');this.touch_fired=true;}},found_suggestions:function(c,d,a){this.parent.found_suggestions(c,d,a);if(this.list.firstChild&&this.list.firstChild.firstChild){CSS.addClass(this.list.firstChild.firstChild,'blue_top_border');CSS.removeClass(this.list,'no_border_list');CSS.addClass(this.list.lastChild.lastChild,'blue_bottom_border');var b=ge('inbox_search');if(b)CSS.addClass(b,'typeahead_border');}else{var b=ge('inbox_search');if(b)CSS.removeClass(b,'typeahead_border');CSS.addClass(this.list,'no_border_list');}}});\nfunction inbox_search_friend_source(a){this.parent.construct(this,a);new AsyncRequest().setMethod('GET').setReadOnly(true).setURI('\/ajax\/inbox\/inbox_search.php?'+a).setErrorHandler(function(){}).setHandler(function(b){this.values=b.getPayload().entries;this.build_index();}.bind(this)).send();}inbox_search_friend_source.extend('static_source');copy_properties(inbox_search_friend_source.prototype,{cache_results:true,gen_html:function(a,b){return ['<div>',typeahead_source.highlight_found(a.t,b),'<\/div><div><small>',a.n,'<\/small><\/div>'].join('');},search_value:function(a){if(!this.is_ready){this.owner.less_than_n_chars=true;return [];}else if(a.length>=2){this.owner.fireTouch();this.owner.less_than_n_chars=false;return this.parent.search_value(a);}return [];}});\nfunction block_people_dialog(e,g,a,b){block_user_helper=function(){var i=serialize_form($('blocked_users'));var h=i.ids;new AsyncRequest().setURI(a).setData({oid:g,blocked_ids:h,block_users:1}).setMethod('POST').setHandler(function(j){if(e!=null)ObjectBrowserController.getController(e).reload('blocked');}.bind(this)).send();};var d=new Dialog().setTitle(_tx(\"Find People to Block\")).setButtons([Dialog.newButton('confirm',_tx(\"Block\"),'',block_user_helper),Dialog.CANCEL]);var f={};var c=new AsyncRequest().setURI(b).setData({q:'',oid:g,init_display:1}).setMethod('POST');render_search_result_handler=function(){CSS.removeClass($('loading'),'hidden_elem');var i=$('search_query').value;var h=new AsyncRequest().setURI(b).setData({q:i,oid:g}).setMethod('POST');d.setAsync(h);};d.setAsync(c).show();}\nfunction ObjectBrowserDataSource(a,b){this.data=a.data;this.id=a.id;this.meta=a.meta;this.object_id=a.object_id;this.object_class=a.object_class;this.count=0;this.currentPage=0;this.pageSize=b;this.pageData=[];if(a.entities){this.pageData[0]=a.entities;this.count=a.count;this.shouldFetch=false;}this.fetchCompleteListener=null;this.scrollTopPosition=0;}copy_properties(ObjectBrowserDataSource.prototype,{fetch:function(a){if(this.pageData[a]){if(this.pageData[a].requested)return;if(this.fetchCompleteListener)this.fetchCompleteListener(this.id,a,this.pageData[a],this.count);}else{this.pageData[a]={requested:true};if(this.object_id)SocialGraphManager.init(this.object_class,this.object_id);SocialGraphManager.fetch(this.data,this.meta,a,this.pageSize,this.onFetchComplete.bind(this));}},search:function(c,b,a){SocialGraphManager.search(c,b,a);},prefetch:function(){if(!this.shouldFetch)return;if(!this.pageData[this.currentPage]){this.fetch(this.currentPage);}else this.fetch(this.currentPage+1);},nextPage:function(){this.currentPage++;this.fetch(this.currentPage);},prevPage:function(){if(this.currentPage>0)this.currentPage--;this.fetch(this.currentPage);},setFetchCompleteListener:function(a){this.fetchCompleteListener=a;},onFetchComplete:function(c){if(!c)return;var b=c.getPayload();if(!b||b.page==null)return;var a=b.page;if(!this.pageData[a]||this.pageData[a].requested)if(b.user_info){this.pageData[a]=b.user_info;}else this.pageData[a]={};this.count=b.count;if(this.fetchCompleteListener)this.fetchCompleteListener(this.id,a,b.user_info,b.count);},removeItem:function(a){if(this.pageData[this.currentPage]&&this.pageData[this.currentPage][a])delete this.pageData[this.currentPage][a];},removePage:function(a){this.pageData[a]=null;}});function ObjectBrowserController(m,a,d,l,k){this.filters={};this.currentFilter=null;this.pageSize=l;this.elementID=a;this.pageData=null;this.pageDataArray=null;this.objectType=k;this.didPrefetchAll=false;this.objects={};this.arbiterTokens=[];this.segments=[];this.itemsPerSegment=10;this.itemHeight=55;this.segmentsFixed=false;this.container=$(a+'_object_browser_body');this.contentArea=$(a+'_object_browser_content_area');this.headerElement=$(a+'_object_browser_header_element');this.tabContainer=$(a+'_object_browser_tab_container');this.pagerNext=ge(a+'_object_browser_pager_more');this.pagerPrev=ge(a+'_object_browser_pager_less');this.searchBox=ge(a+'_object_browser_search_box');this.searchHeader=ge(a+'_object_browser_search_header');this.noResultsBanner=ge(a+'_object_browser_no_results');this.blockPeople=ge(a+'_object_browser_block_people');this.dialog=Dialog.getCurrent();if(d){var b=this.onFilterFetchComplete.bind(this);for(var g=0;g<d.length;g++){var c=new ObjectBrowserDataSource(d[g],this.pageSize);c.setFetchCompleteListener(b);this.filters[d[g].id]=c;if(d[g].selected)this.currentFilter=c;}}if(m)this.renderPage(m);Event.listen(this.container,'scroll',this.onScroll.bind(this));if(this.currentFilter)if(!m||m.length==0){this.showLoadingUI();this.currentFilter.fetch(0);}var h=this.searchBox;var e=this.searchBox;var j=DOM.scry(this.tabContainer,'li');if(j.length){e=j[0];if(!h)h=j[j.length-1];}if(h){var i=h.offsetTop-e.offsetTop;var f=i+h.offsetHeight+3;CSS.setStyle(this.tabContainer,'height',f+'px');}ObjectBrowserController.setController(a,this);}copy_properties(ObjectBrowserController,{controllers:{},getController:function(a){return this.controllers[a];},setController:function(b,a){var c=this.getController(b);if(c)c.cleanup();this.controllers[b]=a;}});copy_properties(ObjectBrowserController.prototype,{setupSegments:function(){var c=this.pageDataArray.length;var d=Math.ceil(c\/this.itemsPerSegment);this.segments=[];var e=null;var b=null;for(var a=0;a<d;a++){var e=$N('div',{className:'object_browser_segment_div clearfix'});var b=$N('div');CSS.setClass(b,'object_browser_segment_loading');CSS.setStyle(b,'height',(this.itemsPerSegment*this.itemHeight)+'px');e.appendContent(b);this.segments.push(e);}if(b)CSS.setStyle(b,'height',((c%this.itemsPerSegment)*this.itemHeight)+'px');DOM.empty(this.contentArea);this.contentArea.appendContent(this.segments);},fixupSegments:function(){if(this.segments.length<=1||this.segmentsFixed)return;this.segmentsFixed=true;var c=this.segments[0].clientHeight;var b=Math.round(c\/this.itemsPerSegment);if(b==this.itemHeight)return;this.itemHeight=b;for(var a=1;a<this.segments.length-1;a++)CSS.setStyle(this.segments[a],'height',c+'px');CSS.setStyle(this.segments[this.segments.length-1],'height',((this.pageDataArray%this.itemsPerSegment)*b)+'px');},cleanup:function(){for(var a=0;a<this.arbiterTokens.length;a++)Arbiter.unsubscribe(this.arbiterTokens[a]);this.arbiterTokens=[];},setPageData:function(a){this.pageData=a;this.pageDataArray=[];for(var b in a)this.pageDataArray.push(a[b]);},onScroll:function(){if(this.drawOnScrollTimeout)clearTimeout(this.drawOnScrollTimeout);this.drawOnScrollTimeout=setTimeout(this.drawOnScroll.bind(this),20);},drawOnScroll:function(){var e=this.container.scrollTop-this.pagerPrev.clientHeight;var d=this.itemsPerSegment*this.itemHeight;var a=Math.floor(e\/d);var c=Math.floor((e+this.container.clientHeight)\/d);a--;c++;for(var b=a;b<=c;b++)this.renderSegment(b);},prefetchAllFilters:function(){if(this.didPrefetchAll)return;this.didPrefetchAll=true;for(var a in this.filters)this.filters[a].prefetch();},onFilterClick:function(b){if(b==this.currentFilter.id)return false;this.currentFilter.scrollTopPosition=this.container.scrollTop;if(this.searchHeader)CSS.addClass(this.searchHeader,'hidden_elem');var a=this.filters[b];if(!a)return false;this.showLoadingUI();this.currentFilter=this.filters[b];a.fetch(a.currentPage);this.clearSearch();Arbiter.inform('\/people_browser\/filterclick\/',{id:b});return false;},setCurrentFilter:function(a){if((a==this.currentFilterID)||!this.filters[a])return;var c=this.elementID+'_filter_tabs';var b=Tabset.getInstance(c);if(!b)return;b.selectTab(c+'_'+a);this.currentFilter=this.filters[a];},nextPage:function(){this.showLoadingUI();this.currentFilter.nextPage();this.currentFilter.prefetch();},prevPage:function(){this.showLoadingUI();this.currentFilter.prevPage();},search:function(){this.showLoadingUI();this.currentFilter.search(this.searchBox.value,{wrapper_id:this.elementID},this.onSearchComplete.bind(this));return false;},showLoadingUI:function(){DOM.empty(this.contentArea);CSS.addClass(this.pagerNext,'hidden_elem');CSS.addClass(this.pagerPrev,'hidden_elem');if(this.dialog)this.dialog.setTitleLoading(true);},hideLoadingUI:function(){if(this.dialog)this.dialog.setTitleLoading(false);},onSearchComplete:function(b){if(!b)return;var a=b.getPayload();if(!a)return;if(a.header){CSS.removeClass(this.searchHeader,'hidden_elem');DOM.setContent(this.searchHeader,HTML(a.header));Event.listen($(this.elementID+'_search_header_cancel_link'),'click',this.onCancelSearch.bind(this));}CSS.addClass(this.pagerNext,'hidden_elem');CSS.addClass(this.pagerPrev,'hidden_elem');this.container.scrollTop=0;this.renderPage(a.user_info);Arbiter.inform('\/people_browser\/search_complete\/',{wrapper_id:this.elementID,filter:this.currentFilter.id});},onCancelSearch:function(){this.clearSearch();this.currentPage=0;this.currentFilter.fetch(0);return false;},clearSearch:function(){if(!this.searchHeader)return;CSS.addClass(this.searchHeader,'hidden_elem');DOM.empty(this.searchHeader);this.searchBox.value=\"\";},onFilterFetchComplete:function(b,c,f,a){if(this.currentFilter.id!=b)return;if(this.filters[b].currentPage!=c)return;if(!this.container)return;CSS.conditionClass(this.blockPeople,'hidden_elem',b!='blocked');this.renderPage(f);this.container.scrollTop=this.filters[b].scrollTopPosition;var d=((c+1)*this.pageSize)<a;var e=c>0;CSS.conditionClass(this.pagerPrev,'hidden_elem',!e);CSS.conditionClass(this.pagerNext,'hidden_elem',!d);},removeItem:function(b){if(!this.objects[b])return;var a=this.objects[b].root;animation(a).blind().to('height','0').duration(300).hide().go();if(this.currentFilter)this.currentFilter.removeItem(b);},replaceItem:function(c,a){if(!this.objects[c])return;var b=this.objects[c].root;var d=this.renderUser(a,true);DOM.replace(b,d.root);},hideActionLink:function(b){if(!this.objects[b])return;var a=this.objects[b].root;CSS.addClass(a,'object_browser_hidden_action');},setHeaderContent:function(a){DOM.setContent(this.headerElement,a);},showHeaderContent:function(a){CSS.conditionClass(this.headerElement,'hidden_elem',!a);},onRemoveClick:function(b){var c=this.pageData[b].title;var a={id:b,title:c,element:this.elementID,obj_label:this.objectType};if(this.pageData[b].removeArgs)copy_properties(a,this.pageData[b].removeArgs);Arbiter.inform('\/people_browser\/remove\/',a);return false;},onActionClick:function(c,a){var d=this.pageData[c].title;var b={id:c,title:d,action:a,element:this.elementID,obj_label:this.objectType};if(this.pageData[c].actionArgs)copy_properties(b,this.pageData[c].actionArgs);Arbiter.inform('\/people_browser\/action\/'+a,b);return false;},addActionHandler:function(a,b){var c=function(d,e){b(e);};this.arbiterTokens.push(Arbiter.subscribe('\/people_browser\/action\/'+a,c));},addRemoveHandler:function(a){var b=function(c,d){a(d);};this.arbiterTokens.push(Arbiter.subscribe('\/people_browser\/remove\/',b));},replaceActionButton:function(d,a,b){var c=new UIActionButton(b).setSuppressMargin(true).setOnclick(this.onActionClick.bind(this,d,a));this.objects[d].setActionControl(c);},renderUser:function(d,b){if(this.objects[d.id]&&!b)return this.objects[d.id];var c=new UIObjectListing(d);c.setPicPadding(true);c.paint();if(d.removeable)c.setRemoveControl(true,this.onRemoveClick.bind(this,d.id));if(d.action){var a=new UIActionButton(d.actionText);a.setSuppressMargin(true);a.setOnclick(this.onActionClick.bind(this,d.id,d.action));c.setActionControl(a);}this.objects[d.id]=c;return c;},renderPage:function(a){this.setPageData(a);this.setupSegments();this.hideLoadingUI();CSS.addClass(this.noResultsBanner,'hidden_elem');this.renderSegment(0);setTimeout(this.renderSegment.bind(this,1),0);setTimeout(this.fixupSegments.bind(this),0);CSS.conditionClass(this.noResultsBanner,'hidden_elem',this.pageDataArray.length!=0);this.prefetchAllFilters();},renderSegment:function(f){if(f<0||f>=this.segments.length)return;if(this.segments[f].rendered)return;var a=f*this.itemsPerSegment;var c=a+this.itemsPerSegment-1;if(f==this.segments.length-1)c=this.pageDataArray.length-1;var e=[];for(var b=a;b<=c;b++){var d=this.renderUser(this.pageDataArray[b],true);e.push(d.root);}DOM.empty(this.segments[f]);DOM.appendContent(this.segments[f],e);this.segments[f].rendered=true;},reload:function(b){this.setCurrentFilter(b);this.currentFilter.scrollTopPosition=this.container.scrollTop;if(this.searchHeader)CSS.addClass(this.searchHeader,'hidden_elem');var a=this.filters[b];if(!a)return false;this.showLoadingUI();this.currentFilter=this.filters[b];this.currentFilter.removePage(a.currentPage);a.fetch(a.currentPage);this.clearSearch();Arbiter.inform('\/people_browser\/filterclick\/',{id:b});return false;}});\nfunction BroadcastManager(){}copy_properties(BroadcastManager,{popup:function(){new AsyncRequest().setURI('\/ajax\/gigaboxx\/endpoint\/BroadcastManager.php').setMethod('GET').setReadOnly(true).send();return false;},popupUnsubscribe:function(a){BroadcastManager.updateSubscription(false,a.id);ObjectBrowserController.getController(a.element).replaceActionButton(a.id,'broadcast_subscribe',_tx(\"Subscribe\"));},popupSubscribe:function(a){BroadcastManager.updateSubscription(true,a.id);ObjectBrowserController.getController(a.element).replaceActionButton(a.id,'broadcast_unsubscribe',_tx(\"Unsubscribe\"));},updateSubscription:function(c,b){var a={action:c?'subscribe':'unsubscribe',oid:b};new AsyncRequest().setURI('\/ajax\/gigaboxx\/endpoint\/BroadcastEndpoint.php').setData(a).setHandler(bagofholding).setErrorHandler(bagofholding).send();}});\nfunction GBTabset(){var a=$N('div',{className:'GBTabset'},$N('span',{className:'GBTabset_Label'},_tx(\"Show: \")));copy_properties(this,{_selectedTab:null,_tabs:{},_tabsetNode:a});}copy_properties(GBTabset.prototype,{getNode:function(){return this._tabsetNode;},addTab:function(f,a,b,d,e){e=!!e;var c=$N('a',{href:b,className:'GBTabset_Pill',onclick:bind(this,this.selectTab,f)},$N('span',null,$N('span',null,$N('span',null,a))));this._tabs[f]={node:c,href:b,onselect:d||bagofholding};if(e){CSS.addClass(c,'selected');this._selectedTab=f;}this._tabsetNode.appendContent(c);return this;},updateTab:function(e,a,b,c){if(this._tabs[e]){var d=this._tabs[e];if(a)d.node.find('span.GBTabset_Pill_Left').setContent(a);if(b){d.href=b;d.node.href=b;}if(c)d.onselect=c;}return this;},forceSelectTab:function(b,a){return this._selectTab(true,b,a);},selectTab:function(b,a){return this._selectTab(false,b,a);},_selectTab:function(b,d,a){if(typeof(this._tabs[d])=='undefined')return true;var c=null;if(this._selectedTab){c=this._tabs[this._selectedTab];CSS.removeClass(c.node,'selected');this._selectedTab=null;}this._selectedTab=d;c=this._tabs[this._selectedTab];CSS.addClass(c.node,'selected');if(!b&&c.onselect()!==false)URI(c.href).go();return false;}});\nfunction GBControlHeader(a){copy_properties(this,{_controller:a,_node:null,_rm:new RenderManager(this),_tabset:null,_selectedTabId:null});}GBControlHeader.mixin({getNode:function(){if(!this._node)this._buildNode();return this._node;},getTabset:function(){return this._tabset;},setSelectedTabId:function(a){if(this._selectedTabId!=a){this._selectedTabId=a;this._rm.dirty();}},paint:function(){if(this._controller.getConfig().showFilters)this._tabset.selectTab(this._selectedTabId);},_buildNode:function(){var b=[];var a=GigaboxxManager.Filters;this._tabset=new GBTabset().addTab('view_all',_tx(\"All\"),this._controller.buildURI().addQueryData({filter:undefined,page:undefined}),null,this._controller.getViewState().getFilter()=='').addTab('view_unread',_tx(\"Unread\"),this._controller.buildURI().addQueryData({filter:a.UNREAD,page:undefined}),null,this._controller.getViewState().getFilter()==a.UNREAD);this._controller.subscribe('gigaboxx\/viewChanged',this._updateTabset.bind(this));var c=[];c.push(_tx(\"Select: {select_type_list}\",{select_type_list:''}));c.push(this._buildSelectLink(_tx(\"All\"),bind(this._controller,this._controller.doSelect,function(d){return true;})));c.push(intl_render_list_separator());c.push(this._buildSelectLink(_tx(\"Read\"),bind(this._controller,this._controller.doSelect,function(d){return !d.isUnread();})));c.push(intl_render_list_separator());c.push(this._buildSelectLink(_tx(\"None\"),bind(this._controller,this._controller.doSelect,function(d){return false;})));b.push($N('span',{className:'GBSelectList'},c));if(this._controller.getConfig().showFilters)b.push(this._tabset.getNode());if(this._controller.getConfig().alternateToolbarUI)return;this._node=$N('div',{className:'GBControlHeader clearfix'},b);},_buildSelectLink:function(c,a){var b=$N('a',{href:'#',onclick:a},c);return b;},_updateTabset:function(){var a=GigaboxxManager.Filters;this._tabset.updateTab('view_all',null,this._controller.buildURI().addQueryData({filter:undefined,page:undefined}),null);this._tabset.updateTab('view_unread',null,this._controller.buildURI().addQueryData({filter:a.UNREAD,page:undefined}),null);}});\nfunction GBErrorView(a){copy_properties(this,{_controller:a});this._initialize();}copy_properties(GBErrorView.prototype,{paint:function(){var a=new Date().getTime();this._paintContentArea();this._controller.debugLog(this._controller.Debug.PAINT,\"Paint Took \"+(new Date().getTime()-a));},hide:function(){if(this._rootContainer.parentNode)DOM.replace(this._rootContainer,null);},show:function(){var a=this._controller.getContentArea();a.appendContent(this._rootContainer);this._controller.hideMuffin();},getTitle:function(){return _tx(\"Error\");},_initialize:function(){if(this._initialized)return;this._initialized=true;this._rootContainer=$N('div',{className:'gigaboxx_error'});},_paintContentArea:function(){var a=new Date().getTime();this._rootContainer.setContent(this._controller.getErrorMsg());this._controller.debugLog(this._controller.Debug.PAINT,\"Message Paint Took \"+(new Date().getTime()-a));}});\nfunction GBSearchRequest(){}copy_properties(GBSearchRequest.prototype,{getId:abstractMethod,getLabel:abstractMethod,getQueryData:abstractMethod});function GBSearchRequestId(a,b){this.parent.construct(this);this.id=a;this.name=b;}GBSearchRequestId.extend('GBSearchRequest');GBSearchRequest.mixin({getId:function(){return 'Id:'+this.id;},getLabel:function(){return this.name;},getQueryData:function(){return {search_id:this.id,search_name:this.name};}});function GBSearchRequestFriendList(a,b){this.parent.construct(this);this.id=a;this.name=b;}GBSearchRequestFriendList.extend('GBSearchRequest');GBSearchRequestFriendList.mixin({getId:function(){return 'List:'+this.id;},getLabel:function(){return this.name;},getQueryData:function(){return {search_list:this.id,search_list_name:this.name};}});function GBSearchRequestTerms(a){this.parent.construct(this);this.terms=a;}GBSearchRequestTerms.extend('GBSearchRequest');GBSearchRequestTerms.mixin({getId:function(){return 'Terms:'+this.terms;},getLabel:function(){return this.terms;},getQueryData:function(){return {search_terms:this.terms};}});\nfunction GBSearchBox(a){copy_properties(this,{_touchSent:false,_typeaheadInitialized:false,_typeaheadObject:null,_controller:a,root:null,typeahead:null});var b=this._controller.getConfig().isHomeboxx?_tx(\"Search Messages\"):_tx(\"Search Inbox\");this.parent.construct(this,URI('\/gigaboxx\/templates\/GBSearchBox.tmpl'),{placeholder:b});new TextInputControl(this.typeahead).setPlaceholderText(this.typeahead.getAttribute('placeholder'));}GBSearchBox.extend('TemplateObject');copy_properties(GBSearchBox.prototype,{getRoot:function(){return this.root;},searchFocus:function(){bind(this,this._doTouch).defer();this._initializeTypeahead();return false;},searchSelectSubmit:function(){if(!$(this.typeahead).isEmpty()){this.searchSubmit();}else this.typeahead.focus();return false;},searchSubmit:function(b){b=this._typeaheadObject.get_current_selection();var a=null;if(b&&b.i){a=new GBSearchRequestId(b.i,b.t);}else if(b&&b.f){a=new GBSearchRequestFriendList(b.f,b.t);}else{var c=this._typeaheadObject.get_value();if(c)a=new GBSearchRequestTerms(c);}if(a){this._controller.buildURI(true).addQueryData(a.getQueryData()).go();this._typeaheadObject.blur();this._typeaheadObject.set_value('');this._typeaheadObject.dirty_results();}return false;},_doTouch:function(){if(!this._touchSent){AsyncRequest.pingURI('\/ajax\/gigaboxx\/endpoint\/SearchTouch.php');this._touchSent=true;}},_initializeTypeahead:function(){if(this._typeaheadInitialized)return;this._typeaheadInitialized=true;var a=new inbox_search_friend_source('');a.search_limit=5;a.text_noinput='';a.text_nomatch='';a.text_placeholder='';this._typeaheadObject=new inbox_search_typeahead(this.typeahead,a,{onsubmit:bind(this,this.searchSubmit),max_results:5});}});\nfunction GBMessageHistoryView(a){copy_properties(this,{_controller:a});}copy_properties(GBMessageHistoryView.prototype,{paint:function(){IL().b('MessageHistory Paint');var a=new Date().getTime();this._paintContentArea();this._controller.debugLog(this._controller.Debug.PAINT,\"Paint Took \"+(new Date().getTime()-a));IL().e('MessageHistory Paint');},hide:function(){var b=this._controller.getContentArea();var a=ge(b.id+'_message_pane');if(a){hide(a);DOM.empty(a);}},show:function(){var a=this._controller.getContentArea();show(a.id+'_message_pane');this._controller.showMuffin();},getTitle:function(){return this._controller.getActiveThreadData().subject||_tx(\"(no subject)\");},_fetchBranch:function(a,c){var b={tid:c.threadId,base_thread:a.threadId};new AsyncRequest().setData(b).setURI('\/ajax\/gigaboxx\/endpoint\/ReadBranch.php').setReadOnly(true).setMethod('GET').setHandler(bind(this,this._fetchBranchHandler,a,c)).setErrorHandler(bind(this,this._fetchBranchError,c)).send();},_fetchBranchHandler:function(b,h,a){var g=a.getPayload();var f=g.thread;var e=ge(b.threadId+'_messages');if(e){if(f.messages){var d=this._buildMessages(b.threadId,f.messages,true);e.prependContent(d.message_nodes);d.onload_script();}if(f.parentThread)e.prependContent(this._buildBranchLink(b,f));}var c=ge('branch_message_'+h.threadId);if(c)c.parentNode.removeChild(c);},_fetchBranchError:function(c,a){var b=ge('branch_message_'+c.threadId);if(b)b.setContent(_tx(\"There was an error trying to get previous messages.  Please try again later.\"));},_showHiddenMessages:function(e,d,b){var c=ge(e+'_messages');if(c){var a=this._buildMessages(e,d,true);c.prependContent(a.message_nodes);a.onload_script();}if(b)DOM.remove(b);},_buildMessages:function(n,h,l){var g=[];var j=\"\";var i=0;var a=false;var m=false;for(var e=h.length-1;e>=0;e--){var f=h[e];var k=new ThreadMessageRow(this._controller,f,n);g=k.getNodes().concat(g);j=j.concat(f.messageOnload);i++;if(!l&&!f.unread&&i>=this._controller.getConfig().messageDisplayCount)break;}if(i<h.length){var o={View_previous_messages_link:''};var c=$N('h6',{className:'gigaboxx_thread_hidden_messages'},[_tx(\"{View_previous_messages_link}\",o)]);var d=this._showHiddenMessages.bind(this,n,h.slice(0,h.length-i),c);var b=$N('a',{onclick:d},_tx(\"Earlier Messages\"));c.appendContent(b);g.unshift(c);}return {message_nodes:g,onload_script:new Function(j)};},_buildBranchLink:function(a,e){var d=this._fetchBranch.bind(this,a,e);var b=$N('a',{onclick:d},_tx(\"View previous thread.\"));var f={View_previous_thread_link:''};var c=$N('h6',{className:'gigaboxx_thread_branch_message',id:'branch_message_'+e.threadId},[_tx(\"This thread has been branched from a previous thread.  {View_previous_thread_link}\",f),b]);return c;},_paintContentArea:function(){var g=new Date().getTime();IL().b('MessageHistory Paint ContentArea');var f=this._controller.getActiveThreadData();var e=[];e.push(this._buildReadMessageHeader(f));if(f.parentThread)e.push(this._buildBranchLink(f,f));var a={message_nodes:null,onload_script:new Function()};if(f.messages)a=this._buildMessages(f.threadId,f.messages);e.push($N('div',{id:f.threadId+'_messages'},a.message_nodes));var b='';if(f.renderedReplyComposer){var d=HTML(f.renderedReplyComposer[0]);e.push(d);b=f.renderedReplyComposer[1];}var c=this._controller.getMessagePane();DOM.setContent(c,e);a.onload_script();(new Function(b))();this._controller.activeThreadMessagesRoot=$(f.threadId+'_messages');IL().e('MessageHistory Paint ContentArea');this._controller.debugLog(this._controller.Debug.PAINT,\"Message Paint Took \"+(new Date().getTime()-g));},_buildReadMessageHeader:function(d){var c=$N('h2',{className:'gigaboxx_thread_header_subject'},d.subject);var a=$N('div',{className:'gigaboxx_thread_header_authors'},HTML(d.renderedAuthorList));var b=$N('div',{className:'gigaboxx_thread_header'},[c,a]);return b;},_getFolderName:function(){var a=this._controller.getViewState();if(a.isSearchRequest())return a.searchRequest.getLabel();switch(a.folder){case GigaboxxManager.Folders.REQUESTS:return _tx(\"Requests\");case GigaboxxManager.Folders.UPDATES:return _tx(\"Updates\");case GigaboxxManager.Folders.SENT:return _tx(\"Sent\");case GigaboxxManager.Folders.MESSAGES:default:return _tx(\"Messages\");}}});\nfunction GigaboxxThreadCache(){copy_properties(this,{_cache:{}});}GigaboxxThreadCache.mixin('Arbiter',{getThreadData:function(a){return this._cache[a]||null;},isCached:function(a){return this._cache[a]!=undefined;},flushCache:function(){this._cache={};},mergeThreadData:function(a){copy_properties(this._cache,a);for(var b in a)this.dirty(b);},mergeMessageData:function(c,b){var a=this._cache[c];if(a){a.snippet=b.message.substr(0,60);this.dirty(c);}},dirty:function(a){this.inform('GigaboxxThreadCache\/dirty\/'+a,null,Arbiter.BEHAVIOR_STATE);},getCache:function(){return this._cache;}});\nfunction UIButtonStrip(){copy_properties(this,{_buttons:[],_disabledStates:[],_wrapperNodes:[],_rm:new RenderManager(this),_root:$N('span',{className:'UIButtonStrip'})});}copy_properties(UIButtonStrip.prototype,{addButton:function(a){a.setSuppressMargin(true);var b=this._buttons.length;this._buttons.push(a);this._disabledStates[b]=a.getDisabled();a.setDisabledOriginal=a.setDisabled;a.setDisabled=this.setDisabled.bind(this,a);this._rm.dirty();return this;},setDisabled:function(a,c){var b=this._buttons.indexOf(a);this._disabledStates[b]=c;this._rm.dirty();return this;},paint:function(){var e=[];var d=null;for(var b=0;b<this._buttons.length;b++){var a=this._buttons[b].getNodes();if(this._wrapperNodes[b]===undefined)e.push(this._wrapperNodes[b]=$N('span',{className:'UIButtonStrip_Wrapper'},a));var f=this._wrapperNodes[b];var c=this._disabledStates[b];if(b>0&&c&&!this._disabledStates[b-1]){CSS.addClass(d,'UIButtonStrip_EnabledToDisabled');CSS.addClass(f,'UIButtonStrip_DisabledFromEnabled');}else{CSS.removeClass(f,'UIButtonStrip_DisabledFromEnabled');if(b>0&&(!c||this._disabledStates[b-1]))CSS.removeClass(d,'UIButtonStrip_EnabledToDisabled');}this._buttons[b].setDisabledOriginal(c);d=f;}if(e)this._root.appendContent(e);return;},getNodes:function(){return [this._root];}});\nfunction GBThreadListView(a){copy_properties(this,{_controller:a,_header:new GBControlHeader(a)});this._initialize();}copy_properties(GBThreadListView.prototype,{paint:function(){var a=new Date().getTime();IL().b('ThreadList Paint');this._paintControlHeader();this._paintContentArea();IL().e('ThreadList Paint');this._controller.debugLog(this._controller.Debug.PAINT,\"Paint Took \"+(new Date().getTime()-a));},hide:function(){var a=this._controller.getContentArea();hide(a.id+'_thread_list');hide(this._header.getNode());},show:function(){var a=this._controller.getContentArea();show(a.id+'_thread_list');show(this._header.getNode());this._controller.hideMuffin();},getTitle:function(){return null;},_initialize:function(){if(this._initialized)return;this._initialized=true;var a=this._controller.getContentArea();a.prependContent(this._header.getNode());},_paintControlHeader:function(){var b=new Date().getTime();IL().b('ThreadList Paint Control');var c=this._controller.getViewState();if(c.getSearchRequest()||(c.getFolder()==GigaboxxManager.Folders.MESSAGES&&c.getSubFolder())||c.getFolder()==GigaboxxManager.Folders.SENT){hide(this._header.getTabset().getNode());}else{var a=null;switch(c.getFilter()){case GigaboxxManager.Filters.UNREAD:a='view_unread';break;case null:default:a='view_all';break;}this._header.getTabset().forceSelectTab(a);show(this._header.getTabset().getNode());}IL().e('ThreadList Paint Control');this._controller.debugLog(this._controller.Debug.PAINT,\"Header Paint Took \"+(new Date().getTime()-b));},_paintContentArea:function(){var e=this._controller.getViewState();var d=new Date().getTime();IL().b('ThreadList Paint ContentArea');var c=this._controller.getViewStateData().list.getPage(this._controller.getPage());for(var a=0;a<this._controller.getPageSize();a++){var b=c&&c[a]||null;this._paintThreadRow(a,b);}this._controller.updateToolbarOnSelect();IL().e('ThreadList Paint ContentArea');this._controller.debugLog(this._controller.Debug.PAINT,\"Message Paint Took \"+(new Date().getTime()-d));},_paintThreadRow:function(a,c){if(c==null){this._controller.setThreadRow(a,null);}else{var b=this._controller.getThreadRow(c);b.paint(a);this._controller.setThreadRow(a,b);}}});\nfunction Collection(e,d){if(!e.__collection__){var a=new Function();for(var c in e.prototype)a.prototype[c]=Collection._call.bind(null,c);e.__collection__=a;}var b=new e.__collection__();b._elements=d;return b;}Collection._call=function(b){var a=Array.prototype.slice.call(arguments,1);this._elements.each(function(c){c[b].apply(c,a);});return this;};\nfunction GBToolbarManager(a,e,c,d,b){copy_properties(this,{_controller:a,_components:{},_searchToolbar:d,_topToolbar:e,_bottomToolbar:c,_pageHeader:b,_needToUpdateBackButton:false});this._controller.subscribe('gigaboxx\/viewChanged',this._viewChanged.bind(this));this._initialize.bind(this).defer();}GBToolbarManager.Locations=['top','bottom','search'];GBToolbarManager.mixin({_viewChanged:function(){this._needToUpdateBackButton=true;},_initialize:function(){IL().b('ToolbarManager initialize');this._initialized=true;var d=this._searchToolbar;var f=this._topToolbar;var b=this._bottomToolbar;var c=this._controller.isDarkUser;d.reset();if(!c)if(this._controller.getConfig().isHomeboxx){var e=DOM.find(this._pageHeader,'div.rfloat');var a=this.getComponent('ComposeButton','top').setSuppressMargin(true);e.appendContent(this.getComponent('SearchBox').getRoot());e.appendContent(a.getNodes());}else d.addContent(this.getComponent('SearchBox').getRoot(),'left');f.reset();f.addContent(this._controller.topPager.getRoot(),'right');f.addContent(this._controller.topMessagePager.getRoot(),'right');f.addButton(this.getComponent('BackButton','top'),'left');if(!c&&!this._controller.getConfig().isHomeboxx)f.addButton(this.getComponent('ComposeButton','top'),'left');f.addButton(this.getComponent('ToolbarDivider','top'),'left');f.addButton(this.getComponent('SelectAllButton','top'),'left');f.addButton(this.getComponent('SelectNoneButton','top'),'left');f.addButton(this.getComponent('ReadButton','top'),'left');f.addButton(this.getComponent('UnreadButton','top'),'left');f.addContent(this.getComponent('DeleteAndReportSpamButtonStrip','top').getNodes(),'left');f.addButton(this.getComponent('UnsubscribeUpdateButton','top'),'left');b.reset();b.addContent(this._controller.bottomPager.getRoot(),'right');b.addContent(this._controller.bottomMessagePager.getRoot(),'right');b.addButton(this.getComponent('BackButton','bottom'),'left');b.addButton(this.getComponent('EditSubscriptionsButton','bottom'),'left');IL().e('ToolbarManager initialize');},paint:function(){var f=new Date().getTime();IL().b('ToolbarManager Paint Toolbar');var b=this._controller.getViewState().getFolder();var c=b==GigaboxxManager.Folders.SENT;var d=b==GigaboxxManager.Folders.UPDATES;switch(this._controller.getView()){case 'read_message':var a=false;if(d){var e=this._controller.getActiveThreadData();a|=e.subscription&&e.subscription.subscribed;}this.getComponent('UnreadButton').setDisabled(c).setHidden(false);this.getComponent('ReadButton').setHidden(true);this.getComponent('ReportSpamButton').setDisabled(c).setHidden(false);this.getComponent('DeleteButton').setDisabled(false).setHidden(false);this.getComponent('UnsubscribeUpdateButton').setDisabled(!a).setHidden(!d);this.getComponent('EditSubscriptionsButton').setHidden(!d);if(!this._controller.getConfig().isHomeboxx){this.getComponent('ComposeButton').setHidden(true);}else this.getComponent('ToolbarDivider').setHidden(false);this.getComponent('BackButton').setHidden(false);this.getComponent('EditSubscriptionsButton').setHidden(true);this.getComponent('SelectAllButton').setHidden(true);this.getComponent('SelectNoneButton').setHidden(true);this._controller.topPager.setHidden(true);this._controller.bottomPager.setHidden(true);this._controller.topMessagePager.setHidden(false);this._controller.bottomMessagePager.setHidden(false);break;case 'thread_list':default:if(!this._controller.getConfig().isHomeboxx){this.getComponent('ComposeButton').setHidden(false);}else this.getComponent('ToolbarDivider').setHidden(true);this.getComponent('BackButton').setHidden(true);this.getComponent('EditSubscriptionsButton').setHidden(!d);this._controller.topPager.setHidden(false);this._controller.bottomPager.setHidden(false);this._controller.topMessagePager.setHidden(true);this._controller.bottomMessagePager.setHidden(true);break;}if(this._needToUpdateBackButton){this.getComponent('BackButton','top').setTitle(this._buildBackButtonContent());this.getComponent('BackButton','bottom').setTitle(this._buildBackButtonContent());this._needToUpdateBackButton=false;}IL().e('ToolbarManager Paint Toolbar');this._controller.debugLog(this._controller.Debug.PAINT,\"Toolbar Paint Took \"+(new Date().getTime()-f));},getComponent:function(b,c){var a=b;if(c!==undefined&&(b!='SearchBox'||b!='PageHeaderText'))a+='_'+c;if(this._components[a]===undefined)this._initComponent(b);return this._components[a];},_initComponent:function(b){var a='_init'+b;if(typeof(this[a])!='function'){this._components[b]=null;}else this[a]();},_buildBackButtonContent:function(){return [_tx(\"Back to {folder_name}\",{folder_name:this._controller.getFolderName()})];},_initSearchBox:function(){this._components.SearchBox=new GBSearchBox(this._controller);return false;},_initPageHeaderText:function(){var a;if(this._pageHeader)a=DOM.find(this._pageHeader,'h2').childNodes[1];this._components.PageHeaderText=a;return false;},_initToolbarDivider:function(){var a=[];GBToolbarManager.Locations.forEach(function(b){a.push(this._components['ToolbarDivider_'+b]=new UIActionButton('').setOnclick(function(){return false;}));CSS.addClass(this._components['ToolbarDivider_'+b].getNodes()[0],'GBToolbarDivider');},this);this._components.ToolbarDivider=new Collection(UIActionButton,a);},_initComposeButton:function(){var a=[];var b=this._controller.getConfig().isHomeboxx?_tx(\"New Message\"):_tx(\"Compose\");GBToolbarManager.Locations.forEach(function(c){a.push(this._components['ComposeButton_'+c]=new UIActionButton(b).setOnclick(Dialog.bootstrap.shield(null,'\/gigaboxx\/dialog\/MessageComposer.php',{},true)).setIcon(UIActionButton.iconPlus));},this);this._components.ComposeButton=new Collection(UIActionButton,a);},_initDeleteAndReportSpamButtonStrip:function(){var a=[];GBToolbarManager.Locations.forEach(function(b){a.push(this._components['DeleteAndReportSpamButtonStrip_'+b]=new UIButtonStrip().addButton(this.getComponent('ReportSpamButton',b)).addButton(this.getComponent('DeleteButton',b)));},this);this._components.DeleteAndReportSpamButtonStrip=new Collection(UIButtonStrip,a);},_initSelectAllButton:function(){this.__initActionButton('SelectAllButton',_tx(\"Select All\"),'select_all');},_initSelectNoneButton:function(){this.__initActionButton('SelectNoneButton',_tx(\"Select None\"),'select_none');},_initDeleteButton:function(){this.__initActionButton('DeleteButton',_tx(\"Delete\"),'delete');},_initUnsubscribeUpdateButton:function(){this.__initActionButton('UnsubscribeUpdateButton',_tx(\"Unsubscribe\"),'unsubscribe');},_initReportSpamButton:function(){this.__initActionButton('ReportSpamButton',_tx(\"Report Spam\"),'report');},_initUnreadButton:function(){this.__initActionButton('UnreadButton',_tx(\"Mark as Unread\"),'unread');},_initReadButton:function(){this.__initActionButton('ReadButton',_tx(\"Mark as Read\"),'read');},_initEditSubscriptionsButton:function(){this.__initButton('EditSubscriptionsButton',_tx(\"Edit Subscriptions\"),BroadcastManager.popup.curry());},_initBackButton:function(){this.__initButton('BackButton',this._buildBackButtonContent(),function(){this._controller.buildURI().go();return false;}.bind(this),UIActionButton.iconBack);},__initActionButton:function(c,b,a){this.__initButton(c,b,bind(this._controller,this._controller.doSelectedAction,a),null,true);},__initButton:function(e,d,f,c,b){var a=[];GBToolbarManager.Locations.forEach(function(g){a.push(this._components[e+'_'+g]=new UIActionButton(d).setOnclick(f).setDisabled(b||false));if(c)this._components[e+'_'+g].setIcon(c);},this);this._components[e]=new Collection(UIActionButton,a);}});\nfunction GBUndoManager(a){copy_properties(this,{_controller:a,_action:$('GBUndoAction'),_currently_displaying:false,_deferred_notification:null});}GBUndoManager.mixin({deferUndoNotification:function(a){this._deferred_notification=a;},hasPendingDeferredNotification:function(){return !!this._deferred_notification;},displayDeferredNotification:function(){this.setUndoNotification(this._deferred_notification);this._deferred_notification=null;},setUndoNotification:function(a){if(!a)return;var b=function(){this._action.setContent($N('span',{className:'GBUndoAction_notification'},[$N('span',{className:'GBUndoAction_notification_text'},HTML(a.text)),$N('a',{className:'GBUndoAction_link',href:'#',onclick:this._sendUndoRequest.bind(this,a.action)},HTML(_tx(\"Undo\")))]));}.bind(this);if(this._currently_displaying){animation(this._action).to('opacity',.5).duration(100).checkpoint(1,b).to('opacity',1).duration(100).go();}else{this._action.style.opacity=0;b();animation(this._action).show().to('height','auto').from('marginTop',0).from('marginBottom',0).to('marginTop',10).to('marginBottom',10).duration(300).checkpoint().to('opacity',1).duration(300).ease(animation.ease.both).go();this._currently_displaying=true;}},clearNotification:function(){if(this._currently_displaying){animation(this._action).to('opacity',0).duration(300).ease(animation.ease.both).checkpoint().to('height',0).from('marginTop',10).from('marginBottom',10).to('marginTop',0).to('marginBottom',0).duration(300).hide().go();this._currently_displaying=false;}},_sendUndoRequest:function(a){new AsyncRequest('\/ajax\/gigaboxx\/endpoint\/UndoAction.php').setMethod('POST').setData({data:a}).setHandler(this._handleUndoResponse.bind(this,a)).setStatusElement(this._action).send();return false;},_handleUndoResponse:function(b,a){DOM.remove(DOM.find(this._action,'.GBUndoAction_link'));if(!this._updateViewOnUndo(b,a))this.clearNotification();},_updateViewOnUndo:function(b,a){switch(b.type){case 'GigaboxxUndoableDeleteAction':case 'GigaboxxUndoableReportAsSpamAction':return this._controller.updateViewOnUndoDelete(a);case 'GigaboxxUndoableUnsubscribeAction':return this._controller.updateViewOnSubscriptionChange(a.getPayload(),true);}return false;}});\nfunction GBViewState(b,d,a,c){copy_properties(this,{_onViewChangeHandler:bagofholding,_onPropertyChangeHandlers:{},folder:b||'',subfolder:d||'',filter:a||'',page:c||1,searchRequest:null});}copy_properties(GBViewState,{constructFromStruct:function(c){var b=new GBViewState();for(var a in c)switch(a){case 'folder':b.setFolder(c[a]);break;case 'subfolder':b.setSubFolder(c[a]);break;case 'filter':b.setFilter(c[a]);break;case 'search_id':b.setSearchRequest(new GBSearchRequestId(c[a].id,c[a].name));break;case 'search_terms':b.setSearchRequest(new GBSearchRequestTerms(c[a]));break;}return b;}});copy_properties(GBViewState.prototype,{isSearchRequest:function(){return !!this.searchRequest;},getViewId:function(){if(this.searchRequest)return 'Search:'+this.searchRequest.getId();return this.folder+':'+this.subfolder+':'+this.filter;},setOnViewChangeHandler:function(a){this._onViewChangeHandler=a;return this;},setOnPropertyChangeHandler:function(b,a){this._onPropertyChangeHandlers[b]=a;return this;},setFolder:function(a){return this._mutate('folder',a);},getFolder:function(){return this.folder;},setSubFolder:function(a){return this._mutate('subfolder',a);},getSubFolder:function(){return this.subfolder;},setFilter:function(a){return this._mutate('filter',a);},getFilter:function(){return this.filter;},setPage:function(a){return this._mutate('page',a);},getPage:function(){return this.page;},setSearchRequest:function(a){return this._mutate('searchRequest',a);},clearSearchRequest:function(){this.setSearchRequest(null);},getSearchRequest:function(){return this.searchRequest;},getViewData:function(){var a={};if(this.searchRequest){copy_properties(a,this.searchRequest.getQueryData());}else{a.folder=this.folder;if(this.subfolder)a.subfolder=this.subfolder;if(this.filter)a.filter=this.filter;}if(this.page)a.page=this.page;return a;},_mutate:function(e,f){var d=this.getViewId();var c=this[e];this[e]=f;var b=this.getViewId();var a=this[e];if(c!=a&&typeof(this._onPropertyChangeHandlers[e])=='function')this._onPropertyChangeHandlers[e]();if(d!=b)this._onViewChangeHandler();return this;},toString:function(){return [\"Folder: \",this.folder,\" Subfolder: \",this.subfolder,\" Filter: \",this.filter,\" Page: \",this.page,\" Search: \",this.searchRequest].join('');}});\nfunction ThreadRow(a,e){copy_properties(this,{threadId:e,_controller:a,_dirty:true,root:null,readLinks:[],authors:null,date:null,subject:null,preview:null,selector:null,selectorLabel:null});this._controller.threadCache.subscribe('GigaboxxThreadCache\/dirty\/'+e,this.dirty.bind(this),Arbiter.SUBSCRIBE_NEW);this.parent.construct(this,URI('\/gigaboxx\/templates\/ThreadRow.tmpl'),{id:e});Event.listen(this.root,'mouseover',CSS.addClass.curry(this.root,'GBThreadRow_Hover'));Event.listen(this.root,'mouseout',CSS.removeClass.curry(this.root,'GBThreadRow_Hover'));var c=[this.selectorLabel,this.icon,this.badge,this.deleteButton];for(var d=0;d<c.length;d++){var b=c[d];Event.listen(b,'mouseover',CSS.addClass.curry(this.root,'GBThreadRow_HoverBlocker'));Event.listen(b,'mouseout',CSS.removeClass.curry(this.root,'GBThreadRow_HoverBlocker'));}}ThreadRow.extend('TemplateObject');copy_properties(ThreadRow.prototype,{deleteMessage:function(){this._controller.deleteMessages(this.threadId);return false;},toggleUnread:function(){if(this._controller.getViewState().getFolder()!=GigaboxxManager.Folders.SENT||this.isUnread())this._controller.setMessageTag(this.threadId,GigaboxxManager.Filters.UNREAD,this.isUnread());return false;},toggleSelect:function(b){b=$E(b);if(b.shiftKey||b.ctrlKey||b.metaKey){var a=this._controller.threadCache.getThreadData(this.threadId);if(a){var c=a.tags.contains(GigaboxxManager.Filters.UNREAD);if((b.shiftKey&&c)||b.ctrlKey||b.metaKey)this._controller.setMessageTag(this.threadId,GigaboxxManager.Filters.UNREAD,c);}b.kill();return false;}this._controller.updateToolbarOnSelect();},readThread:function(b){var c=$E(b).getTarget();if(c&&c.href&&!this._controller.isGigaboxxURI(c.href))return true;var a=URI(this._controller.buildURI()).addQueryData({tid:this.threadId}).go();return false;},isUnread:function(){return this._getThreadData().tags.contains(GigaboxxManager.Filters.UNREAD);},isReplied:function(){var a=this._getThreadData().recentAuthors;return a.length&&a[0]==this._controller.userId;},getFolderTags:function(){return values(GigaboxxManager.Folders).filter(function(a){return this._getThreadData().tags.contains(a);});},_getThreadData:function(){return this._controller.threadCache.getThreadData(this.threadId);},dirty:function(){this._dirty=true;},paint:function(g){if(!this._dirty)return;this._dirty=false;if(this._controller.getConfig().alternateToolbarUI&&!g)CSS.addClass(this.root,'GBThreadRow_NoBorder');var f=this._getThreadData();if(f.inaccessible){if(this._controller.getViewState().isSearchRequest()){CSS.addClass(this.root,'hidden_elem');}else{this._inaccessible=$N('div',{className:'GBThreadRow_InaccessibleWarning'},_tx(\"Sorry, the contents of this thread are temporarily unavailable.\"));DOM.appendContent(this.root,this._inaccessible);CSS.addClass(this.root,'GBThreadRow_Inaccessible');}return;}else if(this._inaccessible){DOM.remove(this._inaccessible);delete this._inaccessible;CSS.removeClass(this.root,'GBThreadRow_Inaccessible');}else CSS.removeClass(this.root,'hidden_elem');var d=[];var e=f.recentAuthorsData;for(var a in e){var b=e[a];if(b.pre)d.push($E(b.pre));if(b.href){var c=$N('a',{href:b.href,title:b.title},b.html);d.push(c);Event.listen(c,'mouseover',CSS.addClass.curry(this.root,'GBThreadRow_HoverBlocker'));Event.listen(c,'mouseout',CSS.removeClass.curry(this.root,'GBThreadRow_HoverBlocker'));}else d.push(b.html);if(b.post)d.push($E(b.post));d.push(intl_render_list_separator());}d.pop();var h=f.snippet;var i=f.subject||_tx(\"(no subject)\");this.icon.src=f.icon.image;this.icon.alt=f.icon.alt;this.iconAnchor.href=f.icon.href;DOM.setContent(this.authors,d);DOM.setContent(this.date,f.timeLastUpdatedRendered);DOM.setContent(this.preview,h);DOM.setContent(this.subject,i);CSS.conditionClass(this.thread_row,'unread',this.isUnread());CSS.conditionClass(this.thread_row,'replied',this.isReplied());}});\nfunction ThreadList(a,f){var e=[];for(var b=0;b<f;b++)e.push($N('div'));var d=$N('div',{className:'ThreadList'},e);var c=a.getContentArea().id+'_thread_list';var g=$N('div',{id:c,className:'ThreadListWrapper'},d);copy_properties(this,{_controller:a,_fallback:null,_threadList:d,_threadListWrapper:g,_rm:new RenderManager(this),_rowNodes:e,_rowObjects:[],_size:f});}copy_properties(ThreadList.prototype,{getNode:function(){return this._threadListWrapper;},getThreadRows:function(){return this._rowObjects;},setSize:function(c){if(c==this._size)return;if(c>this._size){var b=[];for(var a=this._size;a<c;a++){var d=$N('div');this._rowNodes.push(d);b.push(d);}this._threadList.appendContent(b);}else{for(var a=this._size;a>c;a--){var d=this._rowNodes[a-1];while(d.firstChild)d.removeChild(d.firstChild);DOM.remove(d);}this._rowNodes.splice(c,this._size-c);}this._size=c;},setThreadRow:function(a,d){var b=this._rowNodes[a];var c=this._rowObjects[a];if(d!=null){if(c!=d){this._rowObjects[a]=d;while(b.firstChild)b.removeChild(b.firstChild);DOM.setContent(b,d.root);}}else{delete this._rowObjects[a];while(b.firstChild)b.removeChild(b.firstChild);}this._rm.dirty();return this;},paint:function(){if(this._hasThreadRows()){if(this._fallback){DOM.remove(this._fallback);this._fallback=null;}}else if(!this._fallback){this._fallback=$N('div',{className:'ThreadListFallback'},this._buildFallbackContent());this._threadListWrapper.appendContent(this._fallback);}},_hasThreadRows:function(){for(var a=0;a<this._size;a++)if(this._rowObjects[a]!=undefined)return true;return false;},_buildFallbackContent:function(){var b;var e=this._controller.getViewState();if(e.isSearchRequest()){var c='<b>'+htmlize(e.searchRequest.getLabel())+'<\/b>';b=HTML(_tx(\"No messages matched your search for: {search_value}\",{search_value:c}));}else if(e.getFilter()==GigaboxxManager.Filters.UNREAD){var d=this._controller.buildURI().addQueryData({filter:undefined});b=[_tx(\"You currently don't have any unread messages.\"),' ',$N('a',{href:d},_tx(\"View all messages.\"))];}else if(e.getFolder()==GigaboxxManager.Folders.MESSAGES){var a=Dialog.bootstrap.shield(null,'\/gigaboxx\/dialog\/MessageComposer.php',{},true);b=[_tx(\"There are no messages in this view.\"),' ',$N('a',{onclick:a},_tx(\"Compose a message.\"))];}else if(e.getFolder()==GigaboxxManager.Folders.UPDATES)b=[_tx(\"There are no messages in this view.\")];return b;}});\nfunction PaginatedObjectList(a){if(a<=0)a=10;copy_properties(this,{_dirty:{},_objectList:[],_pageHandler:bagofholding,_pageSize:a||10});}copy_properties(PaginatedObjectList.prototype,{getPageSize:function(){return this._pageSize;},hasFullPage:function(f){var g=(f-1)*this._pageSize;var a=Math.min((f)*this._pageSize,this._objectList.length);if(g>=this._objectList.length)return false;var e=a==this._objectList.length;var c=false;var b=false;for(var d=g;d<a;d++)if(typeof(this._objectList[d])=='undefined'){if(!e||(e&&!c)){return false;}else b=true;}else if(e)if(b){return false;}else c=true;return true;},hasPage:function(c){var d=(c-1)*this._pageSize;var a=(c)*this._pageSize;for(var b=d;b<this._objectList.length&&b<a;b++)if(typeof(this._objectList[b])!='undefined')return true;return false;},getPage:function(c){var d=(c-1)*this._pageSize;if(d>(this._objectList.length-1)||d<0)return null;var b=this._objectList.slice(d,d+this._pageSize);var a=b.length-1;while(a>=0&&typeof(b[a])=='undefined')a--;return a>=0?b.slice(0,a+1):null;},setPage:function(c,b){if(!hasArrayNature(b))return this;if(b.length==0)return this;var d=c*this._pageSize;if(this._objectList.length<d)this._objectList.length=d;var a=b.splice(0,this._pageSize);if(a.length<this._pageSize)a.length=this._pageSize;Array.prototype.splice.apply(this._objectList,[d-this._pageSize,this._pageSize].concat(a));if(b.length>0)this.setPage(c+1,b);return this;},unsetPage:function(a){var b=(a-1)*this._pageSize;var c=[];c.length=this._pageSize;this.setPage(a,c);},maxPage:function(){var a=this._objectList.length-1;while(this._objectList[a]===undefined&&a>0)a--;return Math.floor((a\/this._pageSize)+1);},setPageHandler:function(a){this._pageHandler=a;return this;},deleteObject:function(a){var b=false;for(var c=0;c<this._objectList.length;c++)if(this._objectList[c]==a){this._objectList.splice(c,1);b=true;c--;}for(var d=1,e=Math.ceil(this._objectList.length\/this._pageSize);d<=e;d++)this._dirtyPage(d);return this;},_dirtyPage:function(a){if(!this._dirty[a]){this._dirty[a]=true;bind(this,this._doCallback,a).defer();}},_doCallback:function(a){this._dirty[a]=false;this._pageHandler(this,a);}});\nfunction ThreadMessageRow(d,b,f){copy_properties(this,{_controller:d,_data:b,threadId:f,root:null,authorLinkWrapper:null,branchLinkWrapper:null,reportLinkWrapper:null});var c={author_href:b.author.href||this._controller.buildURI().addQueryData({tid:f}),author_pre:b.author.pre,author_name:b.author.name,author_post:b.author.post,author_image_src:b.author.picture,message_date:b.time_rendered,message_body:b.message,message_referrer:b.referrer_rendered||'',message_attachment:b.attachment_rendered||''};this.parent.construct(this,URI('\/gigaboxx\/templates\/ThreadMessageRow.tmpl'),c);if(b.unread)CSS.addClass(this.root,'GBThreadMessageRow_Unread');if(b.can_branch){var g=URI('\/gigaboxx\/dialog\/MessageComposer.php').setQueryData({thread:this.threadId,msg_id:this._data.msg_id,id:this._data.author.id}).toString();var a=$N('a',{href:g,rel:'dialog-post'},_tx(\"Reply\"));DOM.setContent(this.branchLinkWrapper,a);}if(b.report_link){var e=(b.can_branch?' &bull; ':'')+b.report_link;DOM.setContent(this.reportLinkWrapper,HTML(e));}if(!this._data.author.href){DOM.setContent(this.authorLinkWrapper,this._data.author.pre);DOM.setContent(this.authorLinkWrapper,this._data.author.name);DOM.setContent(this.authorLinkWrapper,this._data.author.post);}}ThreadMessageRow.extend('TemplateObject');\nfunction GigaboxxManager(i,c,h,f,g,b,a,e,d){window.gbm=this;this.Debug={NONE:0,ALL:1,STATES:2,PAINT:4,DATA_LOAD:8,DATA:16,DATA_SET:32};this.STATE_MAP={'*GLOBAL*':{Dirty:'CHECK_DATA'},UNINITIALIZED:{},CHECK_DATA:{_action:this._deferCheckDataCache.bind(this),CheckComplete:'LOAD_DATA'},LOAD_DATA:{_action:this._checkDoDataLoad.bind(this),Loaded:'PRE_PAINT',Loading:'LOAD_PENDING'},LOAD_PENDING:{_action:this._pendingDataLoad.bind(this),Pending:'LOAD_PENDING',Failed:'FAILED_LOAD',PendingComplete:'PRE_PAINT'},FAILED_LOAD:{_action:this._doFailedLoadData.bind(this)},PRE_PAINT:{_action:this._doPrePaintHooks.bind(this),PreHooksComplete:'PAINT'},PAINT:{_action:this._doRepaint.bind(this),Painted:'POST_PAINT'},POST_PAINT:{_action:this._doPostPaintHooks.bind(this),PostHooksComplete:'IDLE'},IDLE:{}};if(a.debugLevel)this.debug=a.debugLevel;copy_properties(this,{userId:i,isDarkUser:d,_originalPageTitle:document.title,_config:a||{},_folderNav:c,_pageHeader:e,toolbarManager:new GBToolbarManager(this,h,f,g,e),_contentArea:b,_undo_manager:new GBUndoManager(this),_state:'UNINITIALIZED',_isDirty:false,_blockLoadData:false,_asyncRequestQueue:[],_asyncPendingRequestQueue:[],_prePaintHooks:[],_postPaintHooks:[],_counterSubscription:null,_activeThread:null,_viewState:new GBViewState(GigaboxxManager.Folders.MESSAGES,'','',1).setOnViewChangeHandler(bind(this,this._viewChanged)).setOnPropertyChangeHandler('page',bind(this,this._pageChanged)),_view:GigaboxxManager.Views.THREAD_LIST,_pageSize:a.pageSize,_savedSearches:{},_viewStateData:{},threadCache:new GigaboxxThreadCache(),_threadRows:{},_resetPending:false,_threadList:null,_pagerCollection:null,_messagePagerCollection:null,topPager:null,bottomPager:null,topMessagePager:null,bottomMessagePager:null,_activeThreadData:null,_hasShownMuffin:false,_activeReplyForm:null,activeThreadMessagesRoot:null,_errorCode:null,_errorMsg:null});PageTransitions.registerHandler(this._pageTransitionHandler.bind(this),6);this._initialize();GigaboxxManager.instances[i]=this;}copy_properties(GigaboxxManager,{getInstance:function(a){return GigaboxxManager.instances[a]||null;},instances:{},Folders:{MESSAGES:'[fb]messages',REQUESTS:'[fb]requests',UPDATES:'[fb]updates',SENT:'[fb]sent'},Views:{THREAD_LIST:'thread_list',COMPOSE_MESSAGE:'compose',READ_MESSAGE:'read_message',ERROR:'error'},Filters:{UNREAD:'[fb]unread'}});GigaboxxManager.mixin('Arbiter',{_destroy:function(){if(this._counterSubscription){Arbiter.unsubscribe(this._counterSubscription);delete this._counterSubscription;}},getContentArea:function(){return this._contentArea;},getConfig:function(){return this._config;},isGigaboxxURI:function(e){var c=\/^\\\/(?:gigaboxx|inbox)\\\/\/;if(typeof(e)=='string')e=new URI(e);var d=c.test(e.getPath());if(d)return d;var b=\/^\\\/(?:home.php)?\/;var a=this.interpretURI(e);if(b.test(e.getPath())&&a&&a.folder)return true;return false;},_pageTransitionHandler:function(b){var a=this._pageTransitionHandlerWrapped(b);if(a===false)this._destroy();return a;},_pageTransitionHandlerWrapped:function(b){if(!this.isGigaboxxURI(b))return false;if(b.getQueryData().ref=='mb')return false;var a=this.interpretURI(b);this.load(a||{},true);PageTransitions.transitionComplete();return true;},interpretURI:function(e){var b=e.getQueryData();var d={};var a=b.folder;var c=b.sk;if(a||c){a=a||'[fb]'+c;switch(a){case GigaboxxManager.Folders.MESSAGES:case GigaboxxManager.Folders.REQUESTS:case GigaboxxManager.Folders.UPDATES:case GigaboxxManager.Folders.SENT:d.folder=a;break;default:return null;}}if(typeof(b.subfolder)!='undefined'){d.subfolder=b.subfolder;}else d.subfolder='';if(typeof(b.filter)!='undefined'){d.filter=b.filter;}else d.filter='';if(typeof(b.page)!='undefined'){d.page=b.page;}else d.page=1;if(b.tid){d.thread=b.tid;d.view=GigaboxxManager.Views.READ_MESSAGE;}else d.view=GigaboxxManager.Views.THREAD_LIST;if(b.search_id){d.search_id={id:b.search_id,name:b.search_name||''};}else if(b.search_terms){d.search_terms=b.search_terms;}else if(b.search_list)d.search_list={id:b.search_list,name:b.search_list_name||''};return d;},load:function(c,b){var a=['folder','subfolder','filter','search_terms','search_id','page','thread','view','search_list'];a.forEach(function(d){var e=c[d];if(e!==undefined){this.debugLog(this.Debug.DATA_SET,'Load: ',d,' ',e);switch(d){case 'folder':this.setFolder(e);break;case 'subfolder':this.setSubFolder(e);break;case 'filter':this.setFilter(e);break;case 'view':this.setView(e);break;case 'page':this.setPage(e);break;case 'thread':this.setActiveThread(e);break;case 'search_terms':this.setSearchRequest(new GBSearchRequestTerms(e));break;case 'search_id':this.setSearchRequest(new GBSearchRequestId(e.id,e.name));break;case 'search_list':this.setSearchRequest(new GBSearchRequestFriendList(e.id,e.name));break;}}},this);if(b&&this._config.logCachedViews)this._doCachedAsyncSignal();this._dirty();return false;},setFolder:function(a){if(this._viewState.getFolder()!=a)if(this._isValidFolder(a)){$('gigaboxx_wrapper').removeClass(this._cssClassForFolder(this._viewState.getFolder()));$('gigaboxx_wrapper').addClass(this._cssClassForFolder(a));this.debugLog(this.Debug.DATA,'Switching folder:',a);this._viewState.setFolder(a);this.setSubFolder('');this.setFilter('');this._viewState.clearSearchRequest();if(this._config.isHomeboxx)this._postPaintHooks.push(this._messageHomeNavSelect.bind(this));this._dirty();}},_cssClassForFolder:function(a){if(!a.length)return a;a=a.replace('[fb]','');return 'GBFolder_'+a.charAt(0).toUpperCase()+a.substring(1);},_isValidFolder:function(a){return (a==GigaboxxManager.Folders.MESSAGES||a==GigaboxxManager.Folders.REQUESTS||a==GigaboxxManager.Folders.UPDATES||a==GigaboxxManager.Folders.SENT);},setSubFolder:function(a){this._viewState.setSubFolder(a);this._viewState.setFilter('');if(a)this._viewState.clearSearchRequest();this._dirty();return this;},setFilter:function(a){if(this._viewState.getFilter()!=a)if(this._isValidMessageFilter(a)){this._viewState.setFilter(a);this._viewState.clearSearchRequest();this._dirty();}return this;},setSearchRequest:function(b){this._viewState.setSearchRequest(b);this._viewState.setFolder('');this._viewState.setSubFolder('');this._viewState.setFilter('');if(this._folderNav&&!this._savedSearches[b.getId()]){var a=new UINestedNavItem(b.getId()).setIcon('\/images\/app_icons\/search.gif').setTitle(b.getLabel()).setHref(this.buildURI(true).addQueryData(b.getQueryData())).setCloseHandler(this._deleteSavedSearch.bind(this));this._folderNav.addNavItem(a,true);this._savedSearches[b.getId()]=a;}this._dirty();},setError:function(a,b){if(a){this._errorCode=a;this._errorMsg=b;this.setView(GigaboxxManager.Views.ERROR);}else{this._errorCode=null;this._errorMsg=null;var c=this.interpretURI(URI.getRequestURI());this.load(c||{},true);}this._dirty();return this;},getErrorMsg:function(){return this._errorMsg;},_deleteSavedSearch:function(a){if(this._folderNav&&this._viewState.isSearchRequest()&&this._viewState.searchRequest.getId()==a.id){this.buildURI(true).addQueryData({folder:GigaboxxManager.Folders.MESSAGES}).go();this._folderNav.selectTab('gb_nav_folder_messages');}delete this._savedSearches[a.id];return false;},getViewState:function(){return this._viewState;},_viewChanged:function(){this.setPage(1);for(var a in this._savedSearches){if(this._folderNav)this._folderNav.removeNavItem(this._savedSearches[a]);this._deleteSavedSearch(this._savedSearches[a]);}if(this._resetPending){this.debugLog(this.Debug.DATA,'Performing pending reset.');this.flushCaches();this._resetPending=false;}this.inform('gigaboxx\/viewChanged',this.getViewState());},getFolderName:function(a){if(this._viewState.isSearchRequest())return a?_tx(\"Searching Messages: {search_value}\",{search_value:this._viewState.searchRequest.getLabel()}):_tx(\"Results\");switch(this._viewState.folder){case GigaboxxManager.Folders.REQUESTS:return _tx(\"Requests\");case GigaboxxManager.Folders.UPDATES:return _tx(\"Updates\");case GigaboxxManager.Folders.SENT:return _tx(\"Sent\");case GigaboxxManager.Folders.MESSAGES:default:return _tx(\"Messages\");}},_pageChanged:function(){var a=this._viewState.getPage();if(this._pagerCollection)this._pagerCollection.setPage(a);},_isValidMessageFilter:function(a){var b=values(GigaboxxManager.Filters);return a==''||b.contains(a);},setPageData:function(d,b,a){var c=GBViewState.constructFromStruct(d);this._mergeThreadList(c,b,a);return this;},setActiveThreadData:function(a){this._activeThreadData=a;return this;},getActiveThreadData:function(a){return this._activeThreadData;},getViewStateData:function(e){e=e||this._viewState;var d=e.getViewId();if(this._viewStateData[d]!==undefined){var a=new Date().getTime()-this._viewStateData[d].time;if(a>this._config.cacheExpire){this.debugLog(this.Debug.DATA,'Expiring View: ',d,a);delete this._viewStateData[d];}}if(typeof(this._viewStateData[d])=='undefined'){var c=new PaginatedObjectList(this._pageSize).setPageHandler(bind(this,this._onPageUpdate));var b=-1;this._viewStateData[d]={list:c,count:b,time:new Date().getTime()};}return this._viewStateData[d];},_onPageUpdate:function(a,b){if(this.getViewStateData().list==a)if(this.getPage()==b)if(a.hasFullPage(b)){this._dirty();}else for(var c in this._viewStateData)if(this._viewStateData[c].list==a){this.debugLog(this.Debug.DATA,'Expire View ',c,' on dirty page ',b);delete this._viewStateData[c];this._dirty();}},_onCounterUpdate:function(b,a){this.debugLog(this.Debug.DATA,'Counter update',b,a);this.flushCaches();if(this.isGigaboxxURI(URI.getRequestURI())&&this._view==GigaboxxManager.Views.THREAD_LIST&&this.getPage()==1)this._dirty();},setView:function(a){if(this._view!=a)if(this._isValidView(a)){this._view=a;if(a!=GigaboxxManager.Views.ERROR){this._errorCode=null;this._errorMessage=null;}if(a!=GigaboxxManager.Views.READ_MESSAGE&&this._activeThread)this.setActiveThread(null);this._dirty();}return this;},getView:function(){return this._view;},_isValidView:function(a){if(a==GigaboxxManager.Views.READ_MESSAGE)if(this._activeThread==null)return false;return values(GigaboxxManager.Views).contains(a);},getPage:function(){return this._viewState.getPage();},_computeOffset:function(a,b){a=a||this.getPage();b=b||this._pageSize;return Math.max(a-1,0)*b;},setPage:function(a){if(this._viewState.getPage()!=a){this._viewState.setPage(Math.max(a,1));this._dirty();if(this.getViewStateData().count<0)this._pagerCollection.setTotal(this._computeOffset()+this._pageSize+1);}return this;},setPageSize:function(a){if(a!=this._pageSize){this._threadList.setSize(a);this._pageSize=a;this.topPager.setMaxPerPage(a);this.bottomPager.setMaxPerPage(a);this.flushCaches();this.buildURI(true).go();}},getPageSize:function(){return this._pageSize;},_gotoPageByOffset:function(a){var b=a\/this._pageSize+1;this.buildURI().addQueryData({page:b}).go();},_gotoAdjacentMessage:function(b,a){this._ensurePageCached(this._onLoadThreadListGotoAdjacentMessage.bind(this,b,a,this._viewState));this._dirty();},_onLoadThreadListGotoAdjacentMessage:function(d,c,h,f){if(f)this._onLoadThreadList(h,f);var g=this._getCurrentThreads();var a=this._determineActiveThreadIndex(g,this._activeThread);if(a==-1){this.buildURI().addQueryData({page:this.getPage()}).go();return;}var e=a+c;if(e>=0&&e<g.length){this.buildURI().addQueryData({tid:g[e]}).go();}else{if(e<0){var b=this.getPage();if(b<=1){this.buildURI().addQueryData({page:1}).go();return;}else this.setPage(this.getPage()-1);}else this.setPage(this.getPage()+1);this._ensurePageCached(this._onLoadThreadListGotoThread.bind(this,this._viewState,e>0));this._dirty();}},_onLoadThreadListGotoThread:function(d,a,b){if(b)this._onLoadThreadList(d,b);var c=this._getCurrentThreads();if(!c){this.buildURI().addQueryData({page:this.getPage()-1}).go();}else if(a){this.buildURI().addQueryData({tid:c[0]}).go();}else this.buildURI().addQueryData({tid:c[c.length-1]}).go();},getActiveThread:function(){return this._activeThread;},setActiveThread:function(a){if(this._activeThread!=a&&a){this.debugLog(this.Debug.DATA_LOAD,'New thread: ',this._activeThread,' != ',a);this._prePaintHooks.push(function(c){var b=this._activeThreadData;if(b&&b.threadId==c&&b.tags.contains(GigaboxxManager.Filters.UNREAD)){this._updateTags([c],GigaboxxManager.Filters.UNREAD,true);this._postPaintHooks.push(function(e){var d=this._activeThreadData;if(d&&d.threadId==e)this.setMessageTag(d.threadId,GigaboxxManager.Filters.UNREAD,true,{from_read:1});}.bind(this,c));}}.bind(this,a));}this._activeThread=a;this._messagePagerCollection.setTotal(this._pageSize);this._messagePagerCollection.setPage(this._pageSize\/2);this._dirty();if(this._activeThread==null&&this._view==GigaboxxManager.Views.READ_MESSAGE)this.setView(GigaboxxManager.Views.THREAD_LIST);return this;},_determineActiveThreadIndex:function(c,b){if(!b)return -1;var c=this._getCurrentThreads();for(var a=0;a<c.length;a++)if(c[a]==b)return a;return -1;},buildURI:function(b){var a=URI(this._config.isHomeboxx?'\/':'\/inbox\/');if(!b)a.addQueryData(this._viewState.getViewData());if(this._config.isHomeboxx){a.addQueryData({sk:(this._viewState.folder||GigaboxxManager.Folders.MESSAGES).substr(4)});a.removeQueryData(['folder']);}return a;},_doTransition:function(d){this.debugLog(this.Debug.STATES,'Transition: ',d,' in State:',this._state);var a=this.STATE_MAP['*GLOBAL*'];var c=this.STATE_MAP[this._state];if(!c)return;var b=c[d];if(b==undefined)b=a[d];if(b==undefined)return;this._executeState(b);},_executeState:function(b){this._state=b;var c=this.STATE_MAP[b];if(c){var a=c._action;if(typeof(a)=='function')a();}},_initialize:function(){this._initializeThreadListPlaceholders();this._initializePagers();this._initializeCounterDisplays();this._initializeSubscriptions();this._postPaintHooks.push(this._setVisible.bind(this));},_initializeThreadListPlaceholders:function(){if(this._threadList==null)this._threadList=new ThreadList(this,this._pageSize);this._contentArea.setContent(this._threadList.getNode());},_initializePagers:function(){var b=this._computeOffset();var a=b+this._pageSize+1;var c=this.getViewStateData().count;if(c>=0)a=c;this.topPager=new UIPager(a,this._pageSize,b,this._gotoPageByOffset.bind(this)).setSummaryTextHandler(identity.curry(''));this.bottomPager=new UIPager(a,this._pageSize,b,this._gotoPageByOffset.bind(this)).setSummaryTextHandler(identity.curry(''));this.topMessagePager=new UIPager(this._pageSize,1,this._pageSize\/2,this._gotoAdjacentMessage.bind(this)).setSummaryTextHandler(identity.curry('')).setVertical(true);this.bottomMessagePager=new UIPager(this._pageSize,1,this._pageSize\/2,this._gotoAdjacentMessage.bind(this)).setSummaryTextHandler(identity.curry('')).setVertical(true);this._pagerCollection=new Collection(UIPager,[this.topPager,this.bottomPager]);this._messagePagerCollection=new Collection(UIPager,[this.topMessagePager,this.bottomMessagePager]);},_initializeCounterDisplays:function(){if(this._folderNav){var c=DOM.scry(this._folderNav.getContentArea(),'li.UINestedFilterList_Item');c.forEach(function(f){if(f.id){var g=f.id.match(\/gb_nav_folder_(.*)\/);var e=DOM.scry(f,'div.BubbleCount_Number');var h=DOM.scry(f,'div.BubbleCount');if(g&&e.length>0)new CounterDisplay(g[1]+'_unread',e[0],h[0]);}});}else if(this._config.isHomeboxx)for(var a in GigaboxxManager.Folders){var b=GigaboxxManager.Folders[a].substr(4);var d=DOM.scry($('navigation_item_messages').parentNode,'li.key-'+b);if(d.length)new CounterDisplay(b+'_unread',DOM.scry(d[0],'span.countValue')[0],DOM.scry(d[0],'span.count')[0]);}},_initializeSubscriptions:function(){var c=[];for(var a in GigaboxxManager.Folders){var b=GigaboxxManager.Folders[a].substring(4);c.push(CounterDisplay.EVENT_TYPE_UPDATE+'\/'+b+'_unread');}this._counterSubscription=Arbiter.subscribe(c,this._onCounterUpdate.bind(this),Arbiter.SUBSCRIBE_NEW);},_deferCheckDataCache:function(){if(!this._isDirty){this._isDirty=true;bind(this,this._doCheckDataCache).defer();}},_ensurePageCached:function(b){if(this._threadListPageCached(this._viewState,this.getPage())){this.debugLog(this.Debug.DATA_LOAD,'View Cached. '+this._viewState);b(null);}else{var c={start:this._computeOffset(this._viewState.getPage(),this._pageSize),limit:this._pageSize};var e=this._viewState.getViewData();delete e.page;copy_properties(c,e);var a=new AsyncRequest('\/ajax\/gigaboxx\/endpoint\/ListThreads.php').setMethod('GET').setReadOnly(true).setData(c);var d={async:a,handler:b};this.debugLog(this.Debug.DATA_LOAD,'Need thread list. '+this._viewState);this._asyncRequestQueue.push(d);}},_doCachedAsyncSignal:function(){var b=false;var a={};if(this._view==GigaboxxManager.Views.READ_MESSAGE){if(this._messageCached(this._activeThread)){a={action:'read',tid:this._activeThread};b=true;}}else if(this._view==GigaboxxManager.Views.THREAD_LIST)if(this._threadListPageCached(this._viewState,this.getPage())){a={start:this._computeOffset(this._viewState.getPage(),this._pageSize),limit:this._pageSize};var c=this._viewState.getViewData();delete c.page;copy_properties(a,c);b=true;}if(b){a.cached=true;new AsyncSignal('\/ajax\/gigaboxx\/endpoint\/ListThreads.php',a).send();}},_doCheckDataCache:function(){IL().b('check_data');this._isDirty=false;this.debugLog(this.Debug.STATES,'View State: View\/',this._view,' Folder\/',this._viewState.getFolder(),' Filter\/',this._viewState.getFilter(),' Page\/',this.getPage());if(this._view==GigaboxxManager.Views.ERROR){this.debugLog(this.Debug.DATA_LOAD,'Errored, no data loads');}else if(this._view==GigaboxxManager.Views.READ_MESSAGE){if(!this._messageCached(this._activeThread)){var a=new AsyncRequest('\/ajax\/gigaboxx\/endpoint\/ReadThread.php').setMethod('GET').setReadOnly(true).setData({tid:this._activeThread,readonly:true});var b={async:a,handler:this._onMessageLoad.bind(this)};this.debugLog(this.Debug.DATA_LOAD,'Need Thread History',this._activeThread);this._asyncRequestQueue.push(b);}else if(this._hasShownMuffin){ads_refresh(null,'\/inbox\/message.php',this._onMuffinLoad.bind(this),null,null,null,true);}else this._hasShownMuffin=true;}else this._ensurePageCached(this._onLoadThreadList.bind(this,this._viewState));this._doTransition('CheckComplete');IL().e('check_data');},_checkDoDataLoad:function(){if(this._asyncRequestQueue.length){this._doLoadData.bind(this).deferUntil(function(){return !this._blockLoadData;}.bind(this),10000);if(this._config.isHomeboxx){var a=(this._viewState.folder||GigaboxxManager.Folders.MESSAGES).substr(4);Arbiter.inform(NavigationMessage.NAVIGATION_SELECT,{sk:a,asLoading:true});this._postPaintHooks.push(this._messageHomeNavSelect.bind(this));}else CSS.addClass(this._contentArea,'async_saving');}else this._doTransition('Loaded');},_doLoadData:function(){this._asyncRequestQueue.forEach(function(d){var c=bind(this,this._loadDataHandler,d);var a=bind(this,this._loadDataErrorHandler,d);var b=bind(this,this._loadDataFinallyHandler,d);d.async.setHandler(c).setErrorHandler(a).setFinallyHandler(b);if(!this._config.isHomeboxx)d.async.setStatusElement(this._contentArea);d.async.send();this._asyncPendingRequestQueue.push(d);},this);this._asyncRequestQueue=[];this._doTransition('Loading');},_pendingDataLoad:function(){if(this._asyncPendingRequestQueue.length){this.debugLog(this.Debug.DATA_LOAD,'Pending Request Count: ',this._asyncPendingRequestQueue.length);}else this._doTransition('PendingComplete');},_doFailedLoadData:function(){this.setView(GigaboxxManager.Views.ERROR);this._dirty();},_loadDataHandler:function(a,b){if(typeof(a.handler)=='function')a.handler(b);a.success=true;},_loadDataErrorHandler:function(a,b){if(typeof(a.errorHandler)=='function')a.errorHandler(b);this._errorCode=b.getError();this._errorMsg=b.getErrorDescription();},_loadDataFinallyHandler:function(a,b){this._asyncPendingRequestQueue.remove(a);if(a.success){this._doTransition('Pending');}else this._doTransition('Failed');},_setVisible:function(){$('gigaboxx_wrapper').style.visibility='visible';},_messageHomeNavSelect:function(){var a=(this._viewState.folder||GigaboxxManager.Folders.MESSAGES).substr(4);Arbiter.inform(NavigationMessage.NAVIGATION_SELECT,{sk:a});},_doPrePaintHooks:function(){if(this._prePaintHooks.length){this._prePaintHooks.forEach(function(a){a();});this._prePaintHooks=[];}this._doTransition('PreHooksComplete');},_doPostPaintHooks:function(){if(this._postPaintHooks.length){this._postPaintHooks.forEach(function(a){a();});this._postPaintHooks=[];}this._doTransition('PostHooksComplete');},_doRepaint:function(){bind(this,this._paint).defer();},_dirty:function(){this._doTransition('Dirty');},_paint:function(){IL().b('gb paint');this._isDirty=false;if(!this._threadListView)this._threadListView=new GBThreadListView(this);if(!this._messageHistoryView)this._messageHistoryView=new GBMessageHistoryView(this);if(!this._errorView)this._errorView=new GBErrorView(this);var c=null;switch(this._view){case GigaboxxManager.Views.COMPOSE_MESSAGE:case GigaboxxManager.Views.THREAD_LIST:this._threadListView.paint();c=this._threadListView.getTitle();this._errorView.hide();this._messageHistoryView.hide();this._threadListView.show();break;case GigaboxxManager.Views.READ_MESSAGE:this._messageHistoryView.paint();c=this._messageHistoryView.getTitle();this._errorView.hide();this._threadListView.hide();this._messageHistoryView.show();DOMScroll.scrollTo(new Vector2(0,0,'document'));break;case GigaboxxManager.Views.ERROR:this._errorView.paint();c=this._errorView.getTitle();this._errorView.show();this._messageHistoryView.hide();this._threadListView.hide();break;default:}this.toolbarManager.paint();if(!this._config.isHomeboxx){document.title=c?'Facebook | '+_tx(\"Inbox\")+' - '+c:this._originalPageTitle;}else{var b=this.toolbarManager.getComponent('PageHeaderText');var a=c||this.getFolderName(true);if(DOM.getText(b)!=a)DOM.setContent(b,a);document.title='Facebook | '+a+(c?' - '+c:'');}if(this._undo_manager.hasPendingDeferredNotification()){this._undo_manager.displayDeferredNotification();}else this._undo_manager.clearNotification();this._doTransition('Painted');IL().e('gb paint');},updateToolbarOnSelect:function(){var l=this._getSelectedThreads();var h=this.getViewState().getFolder();var j=(h==GigaboxxManager.Folders.SENT);var k=(h==GigaboxxManager.Folders.UPDATES);var b=l.length>0;var f=false;var c=false;var d=l.length&&(!k||l.length==1);var e=!l.length;var g=false;for(var i=0;i<l.length;i++){var m=l[i];var a=this.threadCache.getThreadData(m);if(!a){c=true;f=true;}else{if(a.tags.contains(GigaboxxManager.Filters.UNREAD)){c=true;}else f=true;if(a.subscription&&a.subscription.subscribed)g=true;}}this.toolbarManager.getComponent('SelectAllButton').setDisabled(false).setHidden(!(this._config.alternateToolbarUI&&e));this.toolbarManager.getComponent('SelectNoneButton').setDisabled(false).setHidden(!this._config.alternateToolbarUI||e);this.toolbarManager.getComponent('UnreadButton').setDisabled(!f||j).setHidden(c);this.toolbarManager.getComponent('ReadButton').setDisabled(false).setHidden(!c);this.toolbarManager.getComponent('DeleteButton').setDisabled(!b).setHidden(false);this.toolbarManager.getComponent('ReportSpamButton').setDisabled(!d||j).setHidden(false);this.toolbarManager.getComponent('UnsubscribeUpdateButton').setDisabled(!g).setHidden(!k);},doSelect:function(a){var e=this.getViewStateData().list.getPage(this.getPage());if(e)for(var c=0;c<e.length;c++){var f=e[c];var d=this._threadRows[f];var b=this.threadCache.getThreadData(f);if(!b||b.inaccessible)continue;if(typeof(a)=='function'&&a(d)){d.selector.checked=true;}else d.selector.checked=false;}this.updateToolbarOnSelect();return false;},_getSelectedThreads:function(){var b=[];if(this._view==GigaboxxManager.Views.READ_MESSAGE){b.push(this._activeThread);}else{var c=this._threadList.getThreadRows();for(var a=0;a<c.length;a++)if(c[a]&&c[a].selector.checked)b.push(c[a].threadId);}return b;},_getCurrentThreads:function(){return this.getViewStateData().list.getPage(this.getPage());},addReplyContent:function(a){var c=false;var e=a.thread_id;var b=a.message;if(e==this._activeThread&&this.activeThreadMessagesRoot){var d=new ThreadMessageRow(this,b,e);DOM.appendContent(this.activeThreadMessagesRoot,d.getNodes());animation(d.root).from('height',0).to('auto').from('opacity',0).to(1).duration(250).ease(animation.ease.both).go();c=true;}if(this._messageCached(e))this._activeThreadData.messages.push(b);if(this.threadCache.isCached(e))this.threadCache.mergeMessageData(e,a.message_raw);return c;},getThreadRow:function(b){if(!this._threadRows[b]){var a=new ThreadRow(this,b);this._threadRows[b]=a;}return this._threadRows[b];},setThreadRow:function(b,a){this._threadList.setThreadRow(b,a);},getMessagePane:function(){var b=this._contentArea.id+'_message_pane';var a=ge(b);if(a==null){a=this._createMessagePane(b);this._contentArea.appendContent(a);}return a;},_createMessagePane:function(b){var a=$N('div',{id:b,className:'message_pane',style:{display:'none'}});return a;},_threadListPageCached:function(c,a){var b=this.getViewStateData(c);return b.list.hasFullPage(a);},_messageCached:function(a){return this._activeThreadData&&this._activeThreadData.threadId==a;},flushCaches:function(){this.debugLog(this.Debug.DATA,'Flushing Caches');this.threadCache.flushCache();this._threadRows={};this._viewStateData={};this._activeThreadData=null;},setMessageTag:function(e,c,f,b){e=arrayize(e);f=!!f;var d=bind(this,this._setMessageTagHandler,e,c,f);this._updateTags(e,c,f);var a={tid:e,tag:c,to_remove:f};copy_properties(a,b||{});new AsyncRequest('\/ajax\/gigaboxx\/endpoint\/TagThread.php').setMethod('POST').setData(a).setErrorHandler(d).setHandler(d).send();if(c==GigaboxxManager.Filters.UNREAD&&f==false&&e.contains(this._activeThread))this.buildURI().go();return false;},_setMessageTagHandler:function(c,b,d,a){if(!a.error&&a.getPayload().success){this._resetPending=true;}else this._updateTags(c,b,!d);},_updateTags:function(f,d,g){var a={};for(var b=0;b<f.length;b++){var e=f[b];this._setCountUpdate(e,d,g,a);if(g){this.debugLog(this.Debug.DATA,'Remove Tag',d,'from',e);if(this.threadCache.isCached(e)){this.threadCache.getThreadData(e).tags.remove(d);this.threadCache.dirty(e);}if(this._messageCached(e))this._activeThreadData.tags.remove(d);}else{this.debugLog(this.Debug.DATA,'Add Tag',d,'from',e);if(this.threadCache.isCached(e)){array_set_add(this.threadCache.getThreadData(e).tags,d);this.threadCache.dirty(e);}if(this._messageCached(e))array_set_add(this._activeThreadData.tags,d);}}for(var c in a)CounterDisplay.adjustCount(c,a[c]);this._dirty();},_setCountUpdate:function(g,e,h,a,i){if(e!=GigaboxxManager.Filters.UNREAD)return;var j=0;var b=[];var c=null;var d=!h;var f=null;if(this.threadCache.isCached(g)){f=this.threadCache.getThreadData(g);c=values(GigaboxxManager.Folders).filter(function(k){return f.tags.contains(k);});d=f.tags.contains(GigaboxxManager.Filters.UNREAD);}else if(this._messageCached(g)){f=this._activeThreadData;c=values(GigaboxxManager.Folders).filter(function(k){return this._activeThreadData.tags.contains(k);},this);d=this._activeThreadData.tags.contains(GigaboxxManager.Filters.UNREAD);}if(d&&h){j=i?1:-1;}else if(!d&&!h)j=i?-1:1;if(c)c.map(function(k){b.push(k.substring(4)+'_unread');});b.forEach(function(k){if(a[k]===undefined)a[k]=0;a[k]+=j;});this._updateSeenThread(f,j);},deleteMessages:function(d){d=arrayize(d);var e={};for(var b=0;b<d.length;b++){var f=d[b];var c=this.threadCache.getThreadData(f);if(!c){this.debugLog(this.Debug.DATA,'Delete missing thread data:',f);continue;}e[f]=c.timeLastUpdated;}var a=this._deleteMessagesHandler.bind(this);new AsyncRequest('\/ajax\/gigaboxx\/endpoint\/DeleteThread.php').setMethod('POST').setData({tids:e}).setStatusElement(this._contentArea).setErrorHandler(a).setHandler(a).setFinallyHandler(this._deleteMessagesFinallyHandler.bind(this)).send();this._deleteThreads(keys(e));return false;},_deleteThreads:function(c,a){if(a||a===undefined){this._blockLoadData=true;for(var e in this._viewStateData){var d=this._viewStateData[e];for(var b=0;b<c.length;b++){this.debugLog(this.Debug.DATA,'Delete thread ',c[b],' in view ',e);d.list.deleteObject(c[b]);}}}},_deleteMessagesHandler:function(d){var e=false;if(!d.error){e=true;var c=d.getPayload();if(c.results)for(var f in c.results)e&=c.results[f];this._undo_manager.deferUndoNotification(c.undo);}else ErrorDialog.showAsyncError(d);if(e){var a={};for(var f in c.results){delete this._threadRows[f];this._setCountUpdate(f,GigaboxxManager.Filters.UNREAD,true,a);}for(var b in a)CounterDisplay.adjustCount(b,a[b]);this.buildURI().go();}else{this.flushCaches();this._dirty();}},_deleteMessagesFinallyHandler:function(a){if(this._blockLoadData){this._blockLoadData=false;this._dirty();}},updateViewOnUndoDelete:function(c){var a={};for(var d in c.getPayload())this._setCountUpdate(d,GigaboxxManager.Filters.UNREAD,true,a,true);for(var b in a)CounterDisplay.adjustCount(b,a[b]);if(this.isGigaboxxURI(URI.getRequestURI())&&this._view==GigaboxxManager.Views.THREAD_LIST){this.flushCaches();this._dirty();return true;}return false;},reportSpam:function(b){b=arrayize(b);var a=this._deleteMessagesHandler.bind(this);new AsyncRequest('\/ajax\/gigaboxx\/endpoint\/ReportThread.php').setMethod('POST').setData({tids:b}).setStatusElement(this._contentArea).setTransportErrorHandler(a).setErrorHandler(a).setFinallyHandler(this._deleteMessagesFinallyHandler.bind(this)).setHandler(a).send();this._deleteThreads(b);return false;},unsubscribeUpdates:function(c){c=arrayize(c);var e={};for(var b=0;b<c.length;b++){var d=c[b];var a=this.threadCache.getThreadData(d);if(!a){e[d]=0;}else if(a.subscription&&a.subscription.subscribed)e[d]=a.originalAuthor;}new AsyncRequest('\/ajax\/gigaboxx\/endpoint\/UnsubscribeUpdate.php').setMethod('POST').setData({tid_sender_map:e}).setStatusElement(this._contentArea).setHandler(this._unsubscribeUpdatesHandler.bind(this)).send();return false;},_unsubscribeUpdatesHandler:function(b){var a=b.getPayload();this.updateViewOnSubscriptionChange(a.results,false);this._undo_manager.setUndoNotification(a.undo);},updateViewOnSubscriptionChange:function(e,b){var a=this.threadCache.getCache();for(var d in a){var c=a[d];if(e[c.originalAuthor])c.subscription.subscribed=b;}if(this._activeThreadData&&e[this._activeThreadData.originalAuthor])this._activeThreadData.subscription.subscribed=b;this.updateToolbarOnSelect();return false;},doSelectedAction:function(b){var a=GigaboxxManager.Filters;var c=this._getSelectedThreads();switch(b){case 'unread':return this.setMessageTag(c,a.UNREAD,false);case 'read':return this.setMessageTag(c,a.UNREAD,true);case 'delete':return this.deleteMessages(c);case 'report':return this.reportSpam(c);case 'select_all':return this.doSelect(function(d){return true;});case 'select_none':return this.doSelect(function(d){return false;});case 'unsubscribe':return this.unsubscribeUpdates(c);}return true;},_onMessageLoad:function(b){var a=b.getPayload();this._activeThreadData=a.thread;this._onMuffinLoad(b);},_updateLastSeenTime:function(){var a=this._viewState.getFolder();if(this._config.fbxGroup&&a==GigaboxxManager.Folders.MESSAGES){new AsyncSignal('\/ajax\/gigaboxx\/endpoint\/UpdateLastSeenTime.php',{folder:a}).send();Arbiter.inform(CounterDisplay.EVENT_TYPE_UPDATE+'\/'+a.substring(4)+'_unseen',0);this._config.lastSeenTime=0;}},_updateSeenThread:function(b,c){var a=this._viewState.getFolder();if(b&&this._config.lastSeenTime&&a==GigaboxxManager.Folders.MESSAGES&&b.timeLastUpdated>this._config.lastSeenTime)Arbiter.inform(CounterDisplay.EVENT_TYPE_ADJUST+'\/'+a.substring(4)+'_unseen',c);},_onMuffinLoad:function(b){var a=b.getPayload();if(a.sidebar_ads)this._setMuffinHtml(a.sidebar_ads);},_onLoadThreadList:function(e,a){this._updateLastSeenTime.bind(this).defer();if(!a)return;var d=a.getPayload().thread_list;if(d){this.threadCache.mergeThreadData(d);var c=[];for(var b in d)c.push(b);this._mergeThreadList(copy_properties({},e),e.getPage(),c);}},_mergeThreadList:function(g,b,f){var e=this.getViewStateData(g).list;var a=0;var c=true;for(var a=0;a<f.length;a+=this._pageSize){var d=f.slice(a,a+this._pageSize);d.push(undefined);if(e.hasPage(b))c=false;if(!c){e.unsetPage(b);this.debugLog(this.Debug.DATA,'Expiring Page: ',b,' on merge');}e.setPage(b,d);b++;}if(!c)for(;b<e.maxPage();b++){e.unsetPage(b);this.debugLog(this.Debug.DATA,'Expiring Page: ',b,' on merge');}},addData:function(a){this.threadCache.mergeThreadData(a);},_setMuffinHtml:function(a){$('gb_muffin_area').innerHTML=a;},showMuffin:function(){$('gb_muffin_area').style.display='block';$('gigaboxx_wrapper').addClass('gb_has_muffin');},hideMuffin:function(){hide('gb_muffin_area');$('gigaboxx_wrapper').removeClass('gb_has_muffin');},debugLog:function(){var a=arguments[0];var b=to_array(arguments);var c=this.Debug.NONE;if(typeof(a)=='number'){c=a;b.shift();}if(((this.debug&c)||(this.debug&this.Debug.ALL))&&window.console&&window.console.log)window.console.log.apply(window.console,b);}});\nfunction MessageComposerContentArea(a){copy_properties(this,{_userId:a});}copy_properties(MessageComposerContentArea,{instances:{},getInstance:function(a){return MessageComposerContentArea.instances[a]||(MessageComposerContentArea.instances[a]=new MessageComposerContentArea(a));}});MessageComposerContentArea.mixin({addContent:function(a){var c=false;if(window.GigaboxxManager){var b=GigaboxxManager.getInstance(this._userId);if(b&&b.isGigaboxxURI(URI.getRequestURI())){if(b.getActiveThread()!=a.thread_id){b.buildURI(true).addQueryData({tid:a.thread_id}).go();}else DOM.find(document,'div.gigaboxx_thread_header_authors').setContent(HTML(a.participant_list));c=b.addReplyContent(a);}}if(!c)new Dialog().setTitle(_tx(\"Message Sent\")).setBody($N('div',{className:'status UIMessageBox'},$N('h2',{id:'status_title'},_tx(\"Your message has been sent.\")))).setAutohide(750).setButtons(Dialog.CLOSE).show();}});\n\nif (window.Bootloader) { Bootloader.done([\"js\\\/7zag5lrpmq8s8wgg.pkg.js\"]); }")